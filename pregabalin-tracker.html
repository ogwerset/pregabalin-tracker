<!DOCTYPE html>
<html lang="pl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Pregabalina Tracker - Dashboard</title>
    
    <!-- Google Fonts -->
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Outfit:wght@300;400;600;700&family=JetBrains+Mono:wght@400;500&display=swap" rel="stylesheet">
    
    <!-- Plotly.js Basic -->
    <script src="https://cdn.plot.ly/plotly-basic-2.27.0.min.js"></script>
    
    <!-- jStat -->
    <script src="https://cdn.jsdelivr.net/npm/jstat@1.9.6/dist/jstat.min.js"></script>
    
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Outfit:wght@300;400;500;600;700&display=swap" rel="stylesheet">
    <style>
        /* ===== CSS VARIABLES ===== */
        :root {
            /* Light Mode */
            --bg-primary: #F8FAFC;
            --bg-card: #FFFFFF;
            --bg-hover: #F1F5F9;
            --text-primary: #1E293B;
            --text-secondary: #64748B;
            --border: #E2E8F0;
            --accent-blue: #3B82F6;
            --accent-green: #10B981;
            --accent-red: #EF4444;
            --accent-amber: #F59E0B;
            --accent-purple: #8B5CF6;
        }
        
        [data-theme="dark"] {
            /* Dark Mode */
            --bg-primary: #0F172A;
            --bg-card: #1E293B;
            --bg-hover: #334155;
            --text-primary: #F1F5F9;
            --text-secondary: #94A3B8;
            --border: #334155;
        }
        
        /* ===== RESET & BASE ===== */
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }
        
        body {
            font-family: 'Outfit', sans-serif;
            background: var(--bg-primary);
            color: var(--text-primary);
            line-height: 1.6;
            transition: background-color 0.3s, color 0.3s;
        }
        
        /* ===== LAYOUT ===== */
        .container {
            max-width: 1400px;
            margin: 0 auto;
            padding: 0 20px;
        }
        
        /* ===== HEADER ===== */
        header {
            background: var(--bg-card);
            border-bottom: 1px solid var(--border);
            padding: 20px 0;
            position: sticky;
            top: 0;
            z-index: 100;
            box-shadow: 0 2px 8px rgba(0,0,0,0.1);
        }
        
        .header-content {
            display: flex;
            justify-content: space-between;
            align-items: center;
        }
        
        header h1 {
            font-size: 1.8rem;
            font-weight: 700;
            background: linear-gradient(135deg, var(--accent-blue), var(--accent-purple));
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            background-clip: text;
        }
        
        .header-actions {
            display: flex;
            gap: 15px;
            align-items: center;
        }
        
        /* ===== NAVIGATION TABS ===== */
        .nav-tabs {
            display: flex;
            gap: 5px;
            margin-top: 20px;
            border-bottom: 2px solid var(--border);
        }
        
        .nav-tab {
            padding: 12px 24px;
            background: transparent;
            border: none;
            border-bottom: 3px solid transparent;
            color: var(--text-secondary);
            font-size: 1rem;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s;
            font-family: 'Outfit', sans-serif;
        }
        
        .nav-tab:hover {
            color: var(--text-primary);
            background: var(--bg-hover);
        }
        
        .nav-tab.active {
            color: var(--accent-blue);
            border-bottom-color: var(--accent-blue);
        }
        
        /* ===== TAB CONTENT ===== */
        .tab-content {
            display: none;
            padding: 40px 0;
            animation: fadeIn 0.3s;
        }
        
        .tab-content.active {
            display: block;
        }
        
        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(10px); }
            to { opacity: 1; transform: translateY(0); }
        }
        
        /* ===== CARDS ===== */
        .card {
            background: var(--bg-card);
            border: 1px solid var(--border);
            border-radius: 12px;
            padding: 30px;
            margin-bottom: 30px;
            box-shadow: 0 2px 8px rgba(0,0,0,0.05);
            transition: box-shadow 0.3s;
        }
        
        .card:hover {
            box-shadow: 0 4px 16px rgba(0,0,0,0.1);
        }
        
        .card h2 {
            font-size: 1.5rem;
            margin-bottom: 20px;
            color: var(--text-primary);
        }
        
        .card h3 {
            font-size: 1.2rem;
            margin-bottom: 15px;
            color: var(--text-primary);
        }
        
        /* ===== FORMS & INPUTS ===== */
        textarea {
            width: 100%;
            min-height: 200px;
            padding: 15px;
            border: 1px solid var(--border);
            border-radius: 8px;
            background: var(--bg-primary);
            color: var(--text-primary);
            font-family: 'JetBrains Mono', monospace;
            font-size: 0.9rem;
            resize: vertical;
            transition: border-color 0.3s;
        }
        
        textarea:focus {
            outline: none;
            border-color: var(--accent-blue);
        }
        
        input[type="file"] {
            margin: 15px 0;
            padding: 10px;
            border: 1px solid var(--border);
            border-radius: 8px;
            background: var(--bg-primary);
            color: var(--text-primary);
            cursor: pointer;
        }
        
        /* ===== BUTTONS ===== */
        .button-group {
            display: flex;
            gap: 10px;
            margin-top: 20px;
            flex-wrap: wrap;
        }
        
        button {
            padding: 12px 24px;
            border: none;
            border-radius: 8px;
            font-size: 1rem;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s;
            font-family: 'Outfit', sans-serif;
        }
        
        .btn-primary {
            background: var(--accent-blue);
            color: white;
        }
        
        .btn-primary:hover {
            background: #2563EB;
            transform: translateY(-2px);
            box-shadow: 0 4px 12px rgba(59, 130, 246, 0.4);
        }
        
        .btn-secondary {
            background: var(--bg-hover);
            color: var(--text-primary);
            border: 1px solid var(--border);
        }
        
        .btn-secondary:hover {
            background: var(--border);
        }
        
        .btn-danger {
            background: var(--accent-red);
            color: white;
        }
        
        .btn-danger:hover {
            background: #DC2626;
        }
        
        .btn-export {
            background: var(--accent-green);
            color: white;
            font-size: 0.9rem;
            padding: 8px 16px;
        }
        
        .btn-export:hover {
            background: #059669;
        }
        
        /* ===== CHARTS CONTAINERS ===== */
        .charts-grid {
            display: grid;
            grid-template-columns: repeat(2, 1fr);
            gap: 30px;
            margin-bottom: 30px;
        }
        
        .chart-card {
            background: var(--bg-card);
            border: 1px solid var(--border);
            border-radius: 12px;
            padding: 25px;
            position: relative;
        }
        
        .chart-card.full-width {
            grid-column: 1 / -1;
        }
        
        .chart-card h3 {
            font-size: 1.2rem;
            margin-bottom: 15px;
            color: var(--text-primary);
        }
        
        .chart-container {
            min-height: 400px;
            background: white;
            border-radius: 8px;
        }
        
        [data-theme="dark"] .chart-container {
            background: #0F172A;
        }
        
        .chart-controls {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-top: 15px;
        }
        
        .segment-checkbox {
            display: flex;
            align-items: center;
            gap: 8px;
        }
        
        .segment-checkbox input[type="checkbox"] {
            width: 18px;
            height: 18px;
            cursor: pointer;
        }
        
        .segment-checkbox label {
            font-size: 0.9rem;
            color: var(--text-secondary);
            cursor: pointer;
        }
        
        .segment-hidden {
            opacity: 0.3;
            pointer-events: none;
        }
        
        /* ===== TABLE ===== */
        .table-wrapper {
            overflow-x: auto;
            margin-top: 20px;
        }
        
        table {
            width: 100%;
            border-collapse: collapse;
            font-family: 'JetBrains Mono', monospace;
            font-size: 0.9rem;
        }
        
        th {
            background: var(--bg-hover);
            padding: 12px;
            text-align: left;
            font-weight: 600;
            border-bottom: 2px solid var(--border);
            color: var(--accent-blue);
            cursor: pointer;
            user-select: none;
        }
        
        th:hover {
            background: var(--border);
        }
        
        td {
            padding: 10px 12px;
            border-bottom: 1px solid var(--border);
        }
        
        tr:hover {
            background: var(--bg-hover);
        }
        
        .table-controls {
            display: flex;
            gap: 15px;
            margin-bottom: 20px;
            flex-wrap: wrap;
        }
        
        .table-controls input,
        .table-controls select {
            padding: 8px 12px;
            border: 1px solid var(--border);
            border-radius: 6px;
            background: var(--bg-card);
            color: var(--text-primary);
        }
        
        /* ===== DOCTOR REPORT ===== */
        .report-container {
            background: var(--bg-card);
            border: 1px solid var(--border);
            border-radius: 12px;
            padding: 40px;
            line-height: 1.8;
        }
        
        .report-section {
            margin-bottom: 40px;
        }
        
        .report-section h3 {
            font-size: 1.5rem;
            margin-bottom: 20px;
            color: var(--accent-blue);
            border-bottom: 2px solid var(--border);
            padding-bottom: 10px;
        }
        
        .report-section h4 {
            font-size: 1.2rem;
            margin-top: 20px;
            margin-bottom: 10px;
            color: var(--text-primary);
        }
        
        .report-section ul {
            margin-left: 30px;
            margin-top: 10px;
        }
        
        .report-section li {
            margin-bottom: 8px;
        }
        
        /* ===== TOAST NOTIFICATIONS ===== */
        #toast-container {
            position: fixed;
            top: 20px;
            right: 20px;
            z-index: 1000;
            display: flex;
            flex-direction: column;
            gap: 10px;
        }
        
        .toast {
            padding: 15px 20px;
            border-radius: 8px;
            box-shadow: 0 4px 12px rgba(0,0,0,0.2);
            animation: slideIn 0.3s;
            min-width: 300px;
            max-width: 500px;
        }
        
        .toast.success {
            background: var(--accent-green);
            color: white;
        }
        
        .toast.error {
            background: var(--accent-red);
            color: white;
        }
        
        .toast.warning {
            background: var(--accent-amber);
            color: white;
        }
        
        @keyframes slideIn {
            from {
                transform: translateX(400px);
                opacity: 0;
            }
            to {
                transform: translateX(0);
                opacity: 1;
            }
        }
        
        /* ===== SKELETON LOADERS ===== */
        .skeleton {
            background: linear-gradient(90deg, var(--bg-hover) 25%, var(--border) 50%, var(--bg-hover) 75%);
            background-size: 200% 100%;
            animation: loading 1.5s infinite;
            border-radius: 8px;
        }
        
        @keyframes loading {
            0% { background-position: 200% 0; }
            100% { background-position: -200% 0; }
        }
        
        .skeleton-text {
            height: 20px;
            margin-bottom: 10px;
        }
        
        .skeleton-chart {
            height: 400px;
        }
        
        /* ===== DARK MODE TOGGLE ===== */
        .theme-toggle {
            background: var(--bg-hover);
            border: 1px solid var(--border);
            border-radius: 8px;
            padding: 8px 12px;
            cursor: pointer;
            color: var(--text-primary);
            font-size: 1.2rem;
            transition: all 0.3s;
        }
        
        .theme-toggle:hover {
            background: var(--border);
        }
        
        /* ===== EXPORT SELECTION PANEL ===== */
        .export-panel {
            background: var(--bg-card);
            border: 1px solid var(--border);
            border-radius: 12px;
            padding: 20px;
            margin-bottom: 30px;
        }
        
        .export-panel h3 {
            font-size: 1.1rem;
            margin-bottom: 15px;
            color: var(--text-primary);
        }
        
        .export-checkboxes {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 10px;
            margin-bottom: 15px;
        }
        
        /* ===== UTILITIES ===== */
        .text-center {
            text-align: center;
        }
        
        .mt-20 {
            margin-top: 20px;
        }
        
        .mb-20 {
            margin-bottom: 20px;
        }
        
        /* ===== RESPONSIVE ===== */
        @media (max-width: 1024px) {
            .charts-grid {
                grid-template-columns: 1fr;
            }
        }
        
        @media (max-width: 768px) {
            header h1 {
                font-size: 1.4rem;
            }
            
            .nav-tabs {
                overflow-x: auto;
                -webkit-overflow-scrolling: touch;
            }
            
            .nav-tab {
                padding: 10px 16px;
                font-size: 0.9rem;
                white-space: nowrap;
            }
            
            .button-group {
                flex-direction: column;
            }
            
            button {
                width: 100%;
            }
            
            .table-wrapper {
                font-size: 0.8rem;
            }
        }
        
        /* ===== PRINT STYLES ===== */
        @media print {
            header,
            .nav-tabs,
            .button-group,
            .chart-controls,
            .export-panel,
            .theme-toggle,
            #toast-container {
                display: none !important;
            }
            
            [data-print-hidden="true"] {
                display: none !important;
            }
            
            body {
                background: white;
                color: black;
            }
            
            .card,
            .chart-card {
                break-inside: avoid;
                page-break-inside: avoid;
            }
            
            .chart-container {
                background: white !important;
            }
        }
    </style>
</head>
<body data-theme="dark">
    <!-- ===== HEADER ===== -->
    <header>
        <div class="container">
            <div class="header-content">
                <h1> Pregabalina Tracker</h1>
                <div class="header-actions">
                    <button class="theme-toggle" id="theme-toggle" title="Przecz tryb jasny/ciemny">
                        
                    </button>
                </div>
            </div>
            
            <!-- Navigation Tabs -->
            <nav class="nav-tabs">
                <button class="nav-tab active" data-tab="tab-import">Import Danych</button>
                <button class="nav-tab" data-tab="tab-dashboard">Dashboard</button>
                <button class="nav-tab" data-tab="tab-table">Tabela</button>
                <button class="nav-tab" data-tab="tab-report">Raport dla Lekarza</button>
            </nav>
        </div>
    </header>
    
    <!-- ===== MAIN CONTENT ===== -->
    <main class="container">
        <!-- TAB 1: Import Danych -->
        <section id="tab-import" class="tab-content active">
            <div class="card">
                <h2>Importuj dane z trackera</h2>
                <p style="color: var(--text-secondary); margin-bottom: 15px;">
                    Wklej dane RAW z notatnika lub zaaduj plik CSV
                </p>
                
                <textarea id="raw-input" placeholder="Wklej tutaj dane z trackera...&#10;&#10;Format:&#10;Data,Czas,JakoSnu,GodzinySnu,Lk,Napicie,BrainFog,Energia,Fokus,PoraDnia,Notatki,Elvanse,ElvanseGodzina,Pregabalina,PregabalinaGodzina&#10;22/12/2025,11:32,3,5,2,6,8,6,6,RANO,-,TAK(70MG),-,TAK(75MG),-"></textarea>
                
                <input type="file" id="csv-upload" accept=".csv,.txt">
                
                <div class="button-group">
                    <button class="btn-primary" id="btn-import">Importuj dane (zastp istniejce)</button>
                    <button class="btn-secondary" id="btn-append">Dodaj do istniejcych</button>
                </div>
                
                <div id="import-feedback" style="margin-top: 15px; padding: 15px; border-radius: 8px; display: none;"></div>
            </div>
            
            <div class="card">
                <h3>Zapisane dane</h3>
                <div id="data-summary">
                    <p style="color: var(--text-secondary);">Brak danych</p>
                </div>
                <div class="button-group">
                    <button class="btn-secondary" id="btn-export-csv">Eksportuj dane jako CSV</button>
                    <button class="btn-danger" id="btn-clear">Wyczy wszystkie dane</button>
                </div>
            </div>
        </section>
        
        <!-- TAB 2: Dashboard Wykres贸w -->
        <section id="tab-dashboard" class="tab-content">
            <!-- Export Selection Panel -->
            <div class="export-panel">
                <h3>Wybierz segmenty do eksportu</h3>
                <div class="export-checkboxes">
                    <div class="segment-checkbox">
                        <input type="checkbox" id="check-chart-gad" checked>
                        <label for="check-chart-gad">Wykres 1: Trajektoria GAD</label>
                    </div>
                    <div class="segment-checkbox">
                        <input type="checkbox" id="check-chart-intraday" checked>
                        <label for="check-chart-intraday">Wykres 2: Profil Dobowy</label>
                    </div>
                    <div class="segment-checkbox">
                        <input type="checkbox" id="check-chart-adhd" checked>
                        <label for="check-chart-adhd">Wykres 3: Stabilno ADHD</label>
                    </div>
                    <div class="segment-checkbox">
                        <input type="checkbox" id="check-stacked-area" checked>
                        <label for="check-stacked-area">Wykres 4: Stacked Area</label>
                    </div>
                    <div class="segment-checkbox">
                        <input type="checkbox" id="check-positive-vs-negative" checked>
                        <label for="check-positive-vs-negative">Wykres 11: Pozytywne vs Negatywne</label>
                    </div>
                    <div class="segment-checkbox">
                        <input type="checkbox" id="check-metrics-by-time" checked>
                        <label for="check-metrics-by-time">Wykres 12: Metryki per Pora</label>
                    </div>
                    <div class="segment-checkbox">
                        <input type="checkbox" id="check-chart-correlation" checked>
                        <label for="check-chart-correlation">Wykres 5: Macierz Korelacji</label>
                    </div>
                    <div class="segment-checkbox">
                        <input type="checkbox" id="check-report" checked>
                        <label for="check-report">Raport dla Lekarza</label>
                    </div>
                </div>
                <div class="button-group">
                    <button class="btn-primary" id="btn-print">Drukuj / Zapisz PDF (tylko wybrane)</button>
                    <button class="btn-export" id="btn-export-png">Eksportuj wybrane jako PNG</button>
                </div>
            </div>
            
            <!-- Charts Grid -->
            <div class="charts-grid">
                <div class="chart-card" id="chart-gad">
                    <div class="chart-controls">
                        <h3>Wykres 1: Trajektoria Leczenia GAD</h3>
                        <div class="segment-checkbox">
                            <input type="checkbox" id="check-gad" checked>
                            <label for="check-gad">Eksport</label>
                        </div>
                    </div>
                    <div id="plot-gad" class="chart-container"></div>
                    <button class="btn-export mt-20" onclick="ChartRenderer.exportChart('plot-gad', 'gad-trajectory')">Pobierz PNG</button>
                </div>
                
                <div class="chart-card" id="chart-intraday">
                    <div class="chart-controls">
                        <h3>Wykres 2: Profil Dobowy Objaw贸w</h3>
                        <div class="segment-checkbox">
                            <input type="checkbox" id="check-intraday" checked>
                            <label for="check-intraday">Eksport</label>
                        </div>
                    </div>
                    <div id="plot-intraday" class="chart-container"></div>
                    <button class="btn-export mt-20" onclick="ChartRenderer.exportChart('plot-intraday', 'intraday-profile')">Pobierz PNG</button>
                </div>
                
                <div class="chart-card" id="chart-adhd">
                    <div class="chart-controls">
                        <h3>Wykres 3: Kontrola Stabilnoci ADHD</h3>
                        <div class="segment-checkbox">
                            <input type="checkbox" id="check-adhd" checked>
                            <label for="check-adhd">Eksport</label>
                        </div>
                    </div>
                    <div id="plot-adhd" class="chart-container"></div>
                    <button class="btn-export mt-20" onclick="ChartRenderer.exportChart('plot-adhd', 'adhd-stability')">Pobierz PNG</button>
                </div>
                
                <div class="chart-card full-width" id="chart-stacked-area">
                    <div class="chart-controls">
                        <h3>Wykres 4: Objawy w Cigu Dnia (Stacked Area)</h3>
                        <div class="segment-checkbox">
                            <input type="checkbox" id="check-stacked-area" checked>
                            <label for="check-stacked-area">Eksport</label>
                        </div>
                    </div>
                    <div id="plot-stacked-area" class="chart-container"></div>
                    <button class="btn-export mt-20" onclick="ChartRenderer.exportChart('plot-stacked-area', 'stacked-area')">Pobierz PNG</button>
                </div>

                <div class="chart-card" id="chart-positive-vs-negative">
                    <div class="chart-controls">
                        <h3>Wykres 11: Korelacja Pozytywne vs Negatywne</h3>
                        <div class="segment-checkbox">
                            <input type="checkbox" id="check-positive-vs-negative" checked>
                            <label for="check-positive-vs-negative">Eksport</label>
                        </div>
                    </div>
                    <div id="plot-positive-vs-negative" class="chart-container"></div>
                    <button class="btn-export mt-20" onclick="ChartRenderer.exportChart('plot-positive-vs-negative', 'positive-vs-negative')">Pobierz PNG</button>
                </div>

                <div class="chart-card" id="chart-metrics-by-time">
                    <div class="chart-controls">
                        <h3>Wykres 12: Metryki per Pora Dnia</h3>
                        <div class="segment-checkbox">
                            <input type="checkbox" id="check-metrics-by-time" checked>
                            <label for="check-metrics-by-time">Eksport</label>
                        </div>
                    </div>
                    <div id="plot-metrics-by-time" class="chart-container"></div>
                    <button class="btn-export mt-20" onclick="ChartRenderer.exportChart('plot-metrics-by-time', 'metrics-by-time')">Pobierz PNG</button>
                </div>
                
                <div class="chart-card full-width" id="chart-sleep">
                    <div class="chart-controls">
                        <h3>Wykres 6: Jako i Godziny Snu</h3>
                        <div class="segment-checkbox">
                            <input type="checkbox" id="check-sleep" checked>
                            <label for="check-sleep">Eksport</label>
                        </div>
                    </div>
                    <div id="plot-sleep" class="chart-container"></div>
                    <button class="btn-export mt-20" onclick="ChartRenderer.exportChart('plot-sleep', 'sleep-analysis')">Pobierz PNG</button>
                </div>

                <div class="chart-card full-width" id="chart-correlation">
                    <div class="chart-controls">
                        <h3>Macierz Korelacji (Zale偶noci)</h3>
                        <div class="segment-checkbox">
                            <input type="checkbox" id="check-correlation" checked>
                            <label for="check-correlation">Eksport</label>
                        </div>
                    </div>
                    <div id="correlation-table-container" class="mt-20" style="overflow-x: auto;">
                        <!-- Tabela korelacji zostanie wygenerowana przez JS -->
                    </div>
                    <div id="correlation-summary" class="mt-20" style="padding: 15px; background: var(--bg-hover); border-radius: 8px; font-size: 0.9rem; border-left: 4px solid var(--accent-blue);">
                        <h4 style="margin-bottom: 10px;"> Kluczowe Zale偶noci:</h4>
                        <div id="correlation-text-summary">Wczytywanie podsumowania korelacji...</div>
                    </div>
                </div>

                <div class="chart-card" id="chart-sleep-anxiety">
                    <div class="chart-controls">
                        <h3>Wykres 7: Sen vs Objawy Nastpnego Dnia</h3>
                        <div class="segment-checkbox">
                            <input type="checkbox" id="check-sleep-anxiety" checked>
                            <label for="check-sleep-anxiety">Eksport</label>
                        </div>
                    </div>
                    <div id="plot-sleep-anxiety" class="chart-container"></div>
                    <button class="btn-export mt-20" onclick="ChartRenderer.exportChart('plot-sleep-anxiety', 'sleep-vs-anxiety')">Pobierz PNG</button>
                </div>

                <div class="chart-card" id="chart-rolling-avg">
                    <div class="chart-controls">
                        <h3>Wykres 8: Trend z Wygadzeniem</h3>
                        <div class="segment-checkbox">
                            <input type="checkbox" id="check-rolling-avg" checked>
                            <label for="check-rolling-avg">Eksport</label>
                        </div>
                    </div>
                    <div id="plot-rolling-avg" class="chart-container"></div>
                    <button class="btn-export mt-20" onclick="ChartRenderer.exportChart('plot-rolling-avg', 'rolling-average')">Pobierz PNG</button>
                </div>

                <div class="chart-card full-width" id="chart-weekly">
                    <div class="chart-controls">
                        <h3>Wykres 9: Por贸wnanie Tygodniowe</h3>
                        <div class="segment-checkbox">
                            <input type="checkbox" id="check-weekly" checked>
                            <label for="check-weekly">Eksport</label>
                        </div>
                    </div>
                    <div id="plot-weekly" class="chart-container"></div>
                    <button class="btn-export mt-20" onclick="ChartRenderer.exportChart('plot-weekly', 'weekly-comparison')">Pobierz PNG</button>
                </div>

                <div class="chart-card" id="chart-radar">
                    <div class="chart-controls">
                        <h3>Wykres 10: Radar Profilu</h3>
                        <div class="segment-checkbox">
                            <input type="checkbox" id="check-radar" checked>
                            <label for="check-radar">Eksport</label>
                        </div>
                    </div>
                    <div id="plot-radar" class="chart-container"></div>
                    <button class="btn-export mt-20" onclick="ChartRenderer.exportChart('plot-radar', 'day-radar')">Pobierz PNG</button>
                </div>
            </div>
        </section>
        
        <!-- TAB 3: Tabela Danych -->
        <section id="tab-table" class="tab-content">
            <div class="card">
                <h2>Tabela Danych</h2>
                <div class="table-controls">
                    <input type="date" id="filter-date-from" placeholder="Data od">
                    <input type="date" id="filter-date-to" placeholder="Data do">
                    <select id="filter-time-of-day">
                        <option value="">Wszystkie pory dnia</option>
                        <option value="RANO">Rano</option>
                        <option value="POUDNIE">Poudnie</option>
                        <option value="POPOUDNIE">Popoudnie</option>
                        <option value="WIECZR">Wiecz贸r</option>
                    </select>
                </div>
                <div class="table-wrapper">
                    <table id="data-table">
                        <thead>
                            <tr>
                                <th data-sort="Data">Data</th>
                                <th data-sort="Czas">Czas</th>
                                <th data-sort="Lk">Lk</th>
                                <th data-sort="Napicie">Napicie</th>
                                <th data-sort="Fokus">Fokus</th>
                                <th data-sort="Energia">Energia</th>
                                <th data-sort="BrainFog">Brain Fog</th>
                                <th data-sort="PoraDnia">Pora Dnia</th>
                                <th data-sort="Pregabalina">Pregabalina</th>
                            </tr>
                        </thead>
                        <tbody>
                            <tr>
                                <td colspan="9" class="text-center" style="padding: 40px; color: var(--text-secondary);">
                                    Brak danych. Zaimportuj dane w zakadce "Import Danych".
                                </td>
                            </tr>
                        </tbody>
                    </table>
                </div>
            </div>
        </section>
        
        <!-- TAB 4: Raport dla Lekarza -->
        <section id="tab-report" class="tab-content">
            <div class="card">
                <h2>Raport dla Lekarza</h2>
                <div class="report-container" id="doctor-report">
                    <p style="color: var(--text-secondary); text-align: center; padding: 40px;">
                        Brak danych. Zaimportuj dane w zakadce "Import Danych", aby wygenerowa raport.
                    </p>
                </div>
            </div>
        </section>
    </main>
    
    <!-- ===== TOAST NOTIFICATIONS ===== -->
    <div id="toast-container"></div>
    
    <!-- ===== APPLICATION JAVASCRIPT ===== -->
    <script>
        /* ===== CONFIG ===== */
        const CONFIG = {
            STORAGE_KEY: 'pregabalin-tracker-data',
            THEME_KEY: 'pregabalin-tracker-theme'
        };
        
        /* ===== DATA PARSER MODULE ===== */
        const DataParser = {
            // Parsuj RAW tekst z notatnika
            parseRAW: function(rawText) {
                if (!rawText || !rawText.trim()) {
                    return { data: [], errors: ['Brak danych do przetworzenia'], skipped: 0 };
                }
                
                const lines = rawText.split('\n').map(line => line.trim()).filter(line => line.length > 0);
                const data = [];
                const errors = [];
                let skipped = 0;
                
                for (let i = 0; i < lines.length; i++) {
                    const line = lines[i];
                    
                    // Pomi nag贸wek CSV
                    if (line.toUpperCase().includes('DATA,CZAS') || line.toUpperCase().includes('DATA, CZAS')) {
                        skipped++;
                        continue;
                    }
                    
                    // Pomi puste linie
                    if (!line || line === ',') {
                        skipped++;
                        continue;
                    }
                    
                    const result = this.validateLine(line, i + 1);
                    if (result.valid) {
                        const normalized = this.normalize(result.data);
                        data.push(normalized);
                    } else {
                        errors.push(result.error);
                        skipped++;
                    }
                }
                
                return { data, errors, skipped };
            },
            
            // Parsuj plik CSV
            parseCSV: function(csvContent) {
                return this.parseRAW(csvContent);
            },
            
            // Waliduj pojedyncz lini
            validateLine: function(line, lineNumber) {
                // Usu trailing whitespace
                line = line.replace(/\s+$/, '');
                
                // Inteligentny split - zachowaj przecinki w notatkach
                // Format: Data,Czas,JakoSnu,GodzinySnu,Lk,Napicie,BrainFog,Energia,Fokus,PoraDnia,Notatki,Elvanse,ElvanseGodzina,Pregabalina,PregabalinaGodzina
                // Indeksy 0-9: stae pola, 10: notatki (mo偶e zawiera przecinki), 11-14: ostatnie 4 pola
                
                const allParts = line.split(',').map(p => p.trim());
                
                // Jeli jest wicej ni偶 15 czci, to notatki zawieraj przecinki
                // Scal rodkowe czci jako notatki
                let parts;
                if (allParts.length > 15) {
                    const extraParts = allParts.length - 15;
                    const first10 = allParts.slice(0, 10);
                    const notatkiParts = allParts.slice(10, 11 + extraParts);
                    const last4 = allParts.slice(11 + extraParts);
                    parts = [...first10, notatkiParts.join(', '), ...last4];
                } else if (allParts.length < 15) {
                    return {
                        valid: false,
                        data: null,
                        error: `Linia ${lineNumber}: Za mao kolumn (oczekiwano min 15, otrzymano ${allParts.length})`
                    };
                } else {
                    parts = allParts;
                }
                
                // Parsuj dat (DD/MM/YYYY) - trim ju偶 zrobiony
                const dateMatch = parts[0].match(/^(\d{2})\/(\d{2})\/(\d{4})$/);
                if (!dateMatch) {
                    return {
                        valid: false,
                        data: null,
                        error: `Linia ${lineNumber}: Nieprawidowy format daty (oczekiwano DD/MM/YYYY, otrzymano: ${parts[0]})`
                    };
                }
                
                // Parsuj czas (HH:MM) - obsu偶 spac przed czasem
                const timeValue = parts[1].replace(/^\s+/, '');
                const timeMatch = timeValue.match(/^(\d{1,2}):(\d{2})$/);
                if (!timeMatch) {
                    return {
                        valid: false,
                        data: null,
                        error: `Linia ${lineNumber}: Nieprawidowy format czasu (oczekiwano HH:MM, otrzymano: ${parts[1]})`
                    };
                }
                parts[1] = timeValue; // Zapisz poprawiony czas
                
                // Waliduj metryki (Lk, Napicie, BrainFog, Energia, Fokus) - musz by 1-10
                const metrics = ['Lk', 'Napicie', 'BrainFog', 'Energia', 'Fokus'];
                const metricIndices = [4, 5, 6, 7, 8];
                
                for (let i = 0; i < metricIndices.length; i++) {
                    const idx = metricIndices[i];
                    const value = parts[idx];
                    if (value && value !== 'N/A' && value !== '-') {
                        const num = parseFloat(value);
                        if (isNaN(num) || num < 1 || num > 10) {
                            return {
                                valid: false,
                                data: null,
                                error: `Linia ${lineNumber}: Warto ${metrics[i]} musi by liczb od 1 do 10 (otrzymano: ${value})`
                            };
                        }
                    }
                }
                
                // Waliduj PoraDnia
                const validTimes = ['RANO', 'POUDNIE', 'POPOUDNIE', 'WIECZR'];
                if (!validTimes.includes(parts[9])) {
                    return {
                        valid: false,
                        data: null,
                        error: `Linia ${lineNumber}: Nieznana pora dnia (dozwolone: ${validTimes.join(', ')}, otrzymano: ${parts[9]})`
                    };
                }
                
                // Jeli wszystko OK, zwr贸 surowe dane
                return {
                    valid: true,
                    data: {
                        Data: parts[0],
                        Czas: parts[1],
                        JakoSnu: parts[2],
                        GodzinySnu: parts[3],
                        Lk: parts[4],
                        Napicie: parts[5],
                        BrainFog: parts[6],
                        Energia: parts[7],
                        Fokus: parts[8],
                        PoraDnia: parts[9],
                        Notatki: parts[10],
                        Elvanse: parts[11],
                        ElvanseGodzina: parts[12],
                        Pregabalina: parts[13],
                        PregabalinaGodzina: parts[14]
                    },
                    error: null
                };
            },
            
            // Normalizuj wartoci
            normalize: function(record) {
                const normalized = { ...record };
                
                // Normalizuj wartoci numeryczne
                const numericFields = ['JakoSnu', 'GodzinySnu', 'Lk', 'Napicie', 'BrainFog', 'Energia', 'Fokus'];
                numericFields.forEach(field => {
                    const value = normalized[field];
                    if (value === 'N/A' || value === '-' || value === 'BRAK' || !value) {
                        normalized[field] = null;
                    } else {
                        const num = parseFloat(value);
                        normalized[field] = isNaN(num) ? null : num;
                    }
                });
                
                // Normalizuj notatki
                if (normalized.Notatki === '-' || normalized.Notatki === 'BRAK' || !normalized.Notatki) {
                    normalized.Notatki = null;
                }
                
                // Ekstrakcja dawek
                normalized.Elvanse_Dawka = this.extractDose(normalized.Elvanse);
                normalized.Pregabalina_Dawka = this.extractDose(normalized.Pregabalina);
                
                // Normalizuj godziny przyjmowania
                if (normalized.ElvanseGodzina === '-' || normalized.ElvanseGodzina === 'N/A' || !normalized.ElvanseGodzina) {
                    normalized.ElvanseGodzina = null;
                }
                if (normalized.PregabalinaGodzina === '-' || normalized.PregabalinaGodzina === 'N/A' || !normalized.PregabalinaGodzina) {
                    normalized.PregabalinaGodzina = null;
                }
                
                // Utw贸rz DateTime
                try {
                    const [day, month, year] = normalized.Data.split('/');
                    const dateStr = `${year}-${month}-${day}`;
                    const [hours, minutes] = normalized.Czas.split(':');
                    normalized.DateTime = new Date(`${dateStr}T${hours.padStart(2, '0')}:${minutes.padStart(2, '0')}:00`);
                } catch (e) {
                    normalized.DateTime = null;
                }
                
                return normalized;
            },
            
            // Ekstrakcja dawki z tekstu
            extractDose: function(text) {
                if (!text || text === '-' || text === 'N/A' || text === 'NIE' || text === 'nie' || text === 'BRAK') {
                    return null;
                }
                
                const match = text.match(/(\d+)MG/i);
                if (match) {
                    return parseInt(match[1], 10);
                }
                
                return null;
            }
        };
        
        /* ===== DATA STORE MODULE ===== */
        const DataStore = {
            STORAGE_KEY: CONFIG.STORAGE_KEY,
            
            // Zapisz dane (nadpisz)
            save: function(data) {
                try {
                    const json = JSON.stringify(data);
                    localStorage.setItem(this.STORAGE_KEY, json);
                    return true;
                } catch (e) {
                    console.error('Bd zapisu do localStorage:', e);
                    return false;
                }
            },
            
            // Wczytaj dane
            load: function() {
                try {
                    const json = localStorage.getItem(this.STORAGE_KEY);
                    if (!json) return [];
                    return JSON.parse(json);
                } catch (e) {
                    console.error('Bd odczytu z localStorage:', e);
                    return [];
                }
            },
            
            // Dodaj nowe dane (append, deduplikacja)
            append: function(newData) {
                const existing = this.load();
                const existingKeys = new Set(existing.map(item => `${item.Data}_${item.Czas}`));
                
                let added = 0;
                let duplicates = 0;
                
                newData.forEach(item => {
                    const key = `${item.Data}_${item.Czas}`;
                    if (!existingKeys.has(key)) {
                        existing.push(item);
                        existingKeys.add(key);
                        added++;
                    } else {
                        duplicates++;
                    }
                });
                
                // Sortuj po dacie i czasie
                existing.sort((a, b) => {
                    if (a.DateTime && b.DateTime) {
                        return a.DateTime - b.DateTime;
                    }
                    if (a.Data !== b.Data) {
                        return a.Data.localeCompare(b.Data);
                    }
                    return a.Czas.localeCompare(b.Czas);
                });
                
                this.save(existing);
                return { added, duplicates };
            },
            
            // Wyczy dane
            clear: function() {
                try {
                    localStorage.removeItem(this.STORAGE_KEY);
                    return true;
                } catch (e) {
                    console.error('Bd czyszczenia localStorage:', e);
                    return false;
                }
            },
            
            // Eksportuj do CSV
            exportCSV: function() {
                const data = this.load();
                if (data.length === 0) {
                    return 'Brak danych do eksportu';
                }
                
                // Nag贸wek
                const headers = ['Data', 'Czas', 'JakoSnu', 'GodzinySnu', 'Lk', 'Napicie', 'BrainFog', 'Energia', 'Fokus', 'PoraDnia', 'Notatki', 'Elvanse', 'ElvanseGodzina', 'Pregabalina', 'PregabalinaGodzina'];
                const rows = [headers.join(',')];
                
                // Dane
                data.forEach(item => {
                    const row = headers.map(header => {
                        const value = item[header] !== null && item[header] !== undefined ? item[header] : '';
                        // Escape commas in values
                        if (typeof value === 'string' && value.includes(',')) {
                            return `"${value}"`;
                        }
                        return value;
                    });
                    rows.push(row.join(','));
                });
                
                return rows.join('\n');
            },
            
            // Statystyki danych
            getStats: function() {
                const data = this.load();
                if (data.length === 0) {
                    return { count: 0, dateRange: null, daysCount: 0, avgPerDay: 0 };
                }
                
                const dates = [...new Set(data.map(d => d.Data))].sort();
                const dateRange = dates.length > 0 ? { start: dates[0], end: dates[dates.length - 1] } : null;
                
                return {
                    count: data.length,
                    dateRange: dateRange,
                    daysCount: dates.length,
                    avgPerDay: dates.length > 0 ? (data.length / dates.length).toFixed(1) : 0
                };
            }
        };
        
        /* ===== STATS ENGINE MODULE ===== */
        const StatsEngine = {
            // Agregacja danych dziennych
            aggregateDaily: function(data) {
                if (!data || data.length === 0) return [];
                
                // Grupuj po dacie
                const dailyGroups = {};
                data.forEach(item => {
                    const date = item.Data;
                    if (!dailyGroups[date]) {
                        dailyGroups[date] = [];
                    }
                    dailyGroups[date].push(item);
                });
                
                // Mapowanie nazw p贸l z polskimi znakami na klucze bez polskich znak贸w
                const fieldMap = {
                    'Lk': 'lek',
                    'Napicie': 'napiecie',
                    'Fokus': 'fokus',
                    'Energia': 'energia',
                    'BrainFog': 'brainfog',
                    'JakoSnu': 'jakoscSnu',
                    'GodzinySnu': 'godzinySnu'
                };
                
                // Oblicz rednie dla ka偶dego dnia
                const dailyData = [];
                Object.keys(dailyGroups).sort((a, b) => {
                    const [ad, am, ay] = a.split('/').map(Number);
                    const [bd, bm, by] = b.split('/').map(Number);
                    return new Date(ay, am-1, ad) - new Date(by, bm-1, bd);
                }).forEach(date => {
                    const items = dailyGroups[date];
                    const daily = { date: date };
                    
                    // Metryki (rednia z dnia)
                    const metrics = {
                        'Lk': 'lek',
                        'Napicie': 'napiecie',
                        'Fokus': 'fokus',
                        'Energia': 'energia',
                        'BrainFog': 'brainfog',
                        'JakoSnu': 'jakoscSnu',
                        'GodzinySnu': 'godzinySnu'
                    };
                    
                    Object.keys(metrics).forEach(mKey => {
                        const values = items.map(i => i[mKey]).filter(v => v !== null && v !== undefined && !isNaN(v));
                        const targetKey = metrics[mKey];
                        daily[targetKey] = values.length > 0 ? values.reduce((a, b) => a + b, 0) / values.length : null;
                    });
                    
                    // Suma dawki pregabaliny na dzie
                    const pregDoses = items.map(i => i.Pregabalina_Dawka).filter(v => v !== null);
                    daily.pregabalinaMg = pregDoses.length > 0 ? pregDoses.reduce((a, b) => a + b, 0) : null;
                    
                    dailyData.push(daily);
                });
                
                return dailyData;
            },
            
            // Agregacja po porze dnia
            aggregateByTimeOfDay: function(data) {
                const timeGroups = {
                    'RANO': [],
                    'POUDNIE': [],
                    'POPOUDNIE': [],
                    'WIECZR': []
                };
                
                data.forEach(item => {
                    const time = item.PoraDnia;
                    if (timeGroups[time]) {
                        timeGroups[time].push(item);
                    }
                });
                
                // Mapowanie nazw p贸l
                const fieldMap = {
                    'Lk': 'lek',
                    'Napicie': 'napiecie',
                    'Fokus': 'fokus',
                    'Energia': 'energia',
                    'BrainFog': 'brainfog'
                };
                
                const result = {};
                Object.keys(timeGroups).forEach(time => {
                    const items = timeGroups[time];
                    const metrics = Object.keys(fieldMap);
                    const stats = {};
                    
                    metrics.forEach(metric => {
                        const values = items.map(i => i[metric]).filter(v => v !== null && v !== undefined && !isNaN(v));
                        if (values.length > 0) {
                            const mean = values.reduce((a, b) => a + b, 0) / values.length;
                            const variance = values.reduce((sum, v) => sum + Math.pow(v - mean, 2), 0) / values.length;
                            const std = Math.sqrt(variance);
                            
                            const key = fieldMap[metric];
                            stats[key] = {
                                mean: mean,
                                std: std,
                                count: values.length,
                                values: values
                            };
                        }
                    });
                    
                    result[time] = stats;
                });
                
                return result;
            },
            
            // Regresja liniowa
            linearRegression: function(x, y) {
                if (!x || !y || x.length !== y.length || x.length < 2) {
                    return { slope: 0, intercept: 0, r: 0, rSquared: 0, pValue: 1, standardError: 0 };
                }
                
                // Filtruj pary gdzie y nie jest null
                const validPairs = [];
                for (let i = 0; i < x.length; i++) {
                    if (y[i] !== null && y[i] !== undefined && !isNaN(y[i])) {
                        validPairs.push({ x: x[i], y: y[i] });
                    }
                }
                
                if (validPairs.length < 2) {
                    return { slope: 0, intercept: 0, r: 0, rSquared: 0, pValue: 1, standardError: 0 };
                }
                
                const n = validPairs.length;
                const xVals = validPairs.map(p => p.x);
                const yVals = validPairs.map(p => p.y);
                
                // rednie
                const xMean = xVals.reduce((a, b) => a + b, 0) / n;
                const yMean = yVals.reduce((a, b) => a + b, 0) / n;
                
                // Oblicz slope i intercept
                let numerator = 0;
                let denominator = 0;
                for (let i = 0; i < n; i++) {
                    numerator += (xVals[i] - xMean) * (yVals[i] - yMean);
                    denominator += Math.pow(xVals[i] - xMean, 2);
                }
                
                const slope = denominator !== 0 ? numerator / denominator : 0;
                const intercept = yMean - slope * xMean;
                
                // Korelacja Pearsona
                let r = 0;
                let xVar = 0;
                let yVar = 0;
                for (let i = 0; i < n; i++) {
                    const xDiff = xVals[i] - xMean;
                    const yDiff = yVals[i] - yMean;
                    r += xDiff * yDiff;
                    xVar += xDiff * xDiff;
                    yVar += yDiff * yDiff;
                }
                r = (xVar > 0 && yVar > 0) ? r / Math.sqrt(xVar * yVar) : 0;
                
                const rSquared = r * r;
                
                // Standard error
                let sumSquaredErrors = 0;
                for (let i = 0; i < n; i++) {
                    const predicted = slope * xVals[i] + intercept;
                    sumSquaredErrors += Math.pow(yVals[i] - predicted, 2);
                }
                const standardError = n > 2 ? Math.sqrt(sumSquaredErrors / (n - 2)) : 0;
                
                // P-value (t-test)
                let pValue = 1;
                if (standardError > 0 && n > 2) {
                    const tStat = Math.abs(slope) / (standardError / Math.sqrt(xVar));
                    if (typeof jStat !== 'undefined' && jStat.studentt) {
                        pValue = 2 * (1 - jStat.studentt.cdf(tStat, n - 2));
                    } else {
                        // Fallback: aproksymacja
                        pValue = tStat > 2 ? 0.05 : 1;
                    }
                }
                
                return { slope, intercept, r, rSquared, pValue, standardError };
            },
            
            // Korelacja Pearsona
            pearsonCorrelation: function(x, y) {
                if (!x || !y || x.length !== y.length || x.length < 2) return 0;
                
                const validPairs = [];
                for (let i = 0; i < x.length; i++) {
                    if (x[i] !== null && y[i] !== null && !isNaN(x[i]) && !isNaN(y[i])) {
                        validPairs.push({ x: x[i], y: y[i] });
                    }
                }
                
                if (validPairs.length < 2) return 0;
                
                if (typeof jStat !== 'undefined' && jStat.corrcoeff) {
                    const xVals = validPairs.map(p => p.x);
                    const yVals = validPairs.map(p => p.y);
                    return jStat.corrcoeff(xVals, yVals);
                }
                
                // Fallback: rczna implementacja
                const n = validPairs.length;
                const xMean = validPairs.reduce((sum, p) => sum + p.x, 0) / n;
                const yMean = validPairs.reduce((sum, p) => sum + p.y, 0) / n;
                
                let numerator = 0;
                let xVar = 0;
                let yVar = 0;
                
                validPairs.forEach(p => {
                    const xDiff = p.x - xMean;
                    const yDiff = p.y - yMean;
                    numerator += xDiff * yDiff;
                    xVar += xDiff * xDiff;
                    yVar += yDiff * yDiff;
                });
                
                return (xVar > 0 && yVar > 0) ? numerator / Math.sqrt(xVar * yVar) : 0;
            },
            
            // Macierz korelacji
            correlationMatrix: function(data, variables) {
                if (!data || data.length === 0 || !variables || variables.length === 0) {
                    return { matrix: [], labels: variables || [] };
                }
                
                // Przygotuj dane - agregacja dzienna
                const dailyData = this.aggregateDaily(data);
                if (dailyData.length === 0) {
                    return { matrix: [], labels: variables };
                }
                
                // Mapuj nazwy zmiennych na pola w danych
                const fieldMap = {
                    'lek': 'lek',
                    'napiecie': 'napiecie',
                    'jakoscsnu': 'jakoscSnu',
                    'brainfog': 'brainfog',
                    'energia': 'energia',
                    'fokus': 'fokus',
                    'pregabalina': 'pregabalinaMg'
                };
                
                // Pobierz wartoci dla ka偶dej zmiennej
                const varData = {};
                variables.forEach(v => {
                    const field = fieldMap[v.toLowerCase()] || v.toLowerCase();
                    varData[v] = dailyData.map(d => d[field]).filter(v => v !== null && v !== undefined);
                });
                
                // Oblicz macierz korelacji
                const matrix = [];
                variables.forEach((v1, i) => {
                    const row = [];
                    variables.forEach((v2, j) => {
                        if (i === j) {
                            row.push(1.0);
                        } else {
                            const corr = this.pearsonCorrelation(varData[v1], varData[v2]);
                            row.push(isNaN(corr) ? 0 : corr);
                        }
                    });
                    matrix.push(row);
                });
                
                return { matrix, labels: variables };
            },
            
            // Por贸wnanie po贸w
            compareHalves: function(dailyData) {
                if (!dailyData || dailyData.length === 0) {
                    return { firstHalf: {}, secondHalf: {}, change: {} };
                }
                
                const mid = Math.ceil(dailyData.length / 2);
                const firstHalf = dailyData.slice(0, mid);
                const secondHalf = dailyData.slice(mid);
                
                const metrics = ['lek', 'napiecie', 'fokus', 'energia', 'brainfog', 'jakoscSnu'];
                const result = { firstHalf: {}, secondHalf: {}, change: {} };
                
                metrics.forEach(metric => {
                    const firstValues = firstHalf.map(d => d[metric]).filter(v => v !== null && v !== undefined);
                    const secondValues = secondHalf.map(d => d[metric]).filter(v => v !== null && v !== undefined);
                    
                    if (firstValues.length > 0 && secondValues.length > 0) {
                        const firstMean = firstValues.reduce((a, b) => a + b, 0) / firstValues.length;
                        const secondMean = secondValues.reduce((a, b) => a + b, 0) / secondValues.length;
                        
                        result.firstHalf[metric] = firstMean;
                        result.secondHalf[metric] = secondMean;
                        result.change[metric] = firstMean !== 0 ? ((secondMean - firstMean) / firstMean) * 100 : 0;
                    }
                });
                
                return result;
            },
            
            // Przygotuj dane do heatmapy Dni  Pora Dnia
            prepareDayTimeMatrix: function(data, metric) {
                if (!data || data.length === 0) return { dates: [], timeOfDay: [], matrix: [] };
                
                // Pobierz unikalne daty i pory dnia
                const dates = [...new Set(data.map(d => d.Data))].sort((a, b) => {
                    const [d1, m1, y1] = a.split('/').map(Number);
                    const [d2, m2, y2] = b.split('/').map(Number);
                    return new Date(y1, m1-1, d1) - new Date(y2, m2-1, d2);
                });
                const timeOfDay = ['RANO', 'POUDNIE', 'POPOUDNIE', 'WIECZR'];
                
                // Mapuj nazw metryki na pola w znormalizowanych danych
                const metricMap = {
                    'lek': 'Lk',
                    'napiecie': 'Napicie',
                    'fokus': 'Fokus',
                    'energia': 'Energia',
                    'brainfog': 'BrainFog'
                };
                
                const metricField = metricMap[metric.toLowerCase()] || metric;
                const isInvertMetric = metric.toLowerCase() === 'brainfog';
                
                // Utw贸rz macierz (pust)
                const matrix = timeOfDay.map(() => dates.map(() => null));
                
                // Wypenij macierz rednimi wartociami
                dates.forEach((date, dateIdx) => {
                    timeOfDay.forEach((time, timeIdx) => {
                        const items = data.filter(d => d.Data === date && d.PoraDnia === time);
                        if (items.length > 0) {
                            const values = items.map(i => {
                                const v = i[metricField];
                                if (v === null || v === undefined || isNaN(v)) return null;
                                return isInvertMetric ? 11 - v : v;
                            }).filter(v => v !== null);
                            
                            if (values.length > 0) {
                                matrix[timeIdx][dateIdx] = values.reduce((a, b) => a + b, 0) / values.length;
                            }
                        }
                    });
                });
                
                return { dates, timeOfDay, matrix };
            },
            
            // Oblicz rednie i trendy dla okres贸w 3-dniowych
            compute3DayPeriods: function(dailyData) {
                if (!dailyData || dailyData.length === 0) return [];
                
                const periods = [];
                const metrics = ['lek', 'napiecie', 'fokus', 'energia', 'brainfog', 'jakoscSnu'];
                
                // Podziel dane na okresy 3-dniowe
                for (let i = 0; i < dailyData.length; i += 3) {
                    const periodData = dailyData.slice(i, i + 3);
                    if (periodData.length === 0) continue;
                    
                    const period = {
                        periodNumber: Math.floor(i / 3) + 1,
                        startDate: periodData[0].date,
                        endDate: periodData[periodData.length - 1].date,
                        days: periodData.length,
                        averages: {},
                        trends: {}
                    };
                    
                    // Oblicz rednie dla ka偶dej metryki
                    metrics.forEach(metric => {
                        const values = periodData.map(d => d[metric]).filter(v => v !== null && v !== undefined);
                        if (values.length > 0) {
                            period.averages[metric] = values.reduce((a, b) => a + b, 0) / values.length;
                        } else {
                            period.averages[metric] = null;
                        }
                    });
                    
                    // Oblicz trend (slope) dla ka偶dej metryki w tym okresie
                    metrics.forEach(metric => {
                        const values = periodData.map(d => d[metric]).filter(v => v !== null && v !== undefined);
                        if (values.length >= 2) {
                            const dayNumbers = values.map((_, idx) => idx + 1);
                            const trend = this.linearRegression(dayNumbers, values);
                            period.trends[metric] = trend ? trend.slope : 0;
                        } else {
                            period.trends[metric] = 0;
                        }
                    });
                    
                    periods.push(period);
                }
                
                return periods;
            },
            
            // G贸wna funkcja obliczajca wszystkie statystyki
            computeAll: function(data) {
                if (!data || data.length === 0) {
                    return {
                        period: { start: null, end: null, days: 0, measurements: 0 },
                        gadTrend: { lek: {}, napiecie: {} },
                        comparison: {},
                        adhdStability: {},
                        intradayPatterns: {},
                        threeDayPeriods: []
                    };
                }
                
                const dailyData = this.aggregateDaily(data);
                const dates = [...new Set(data.map(d => d.Data))].sort();
                
                // Okres obserwacji
                const period = {
                    start: dates[0] || null,
                    end: dates[dates.length - 1] || null,
                    days: dates.length,
                    measurements: data.length
                };
                
                // Trendy GAD (regresja liniowa)
                const dayNumbers = dailyData.map((_, i) => i + 1);
                const lekValues = dailyData.map(d => d.lek).filter(v => v !== null);
                const napiecieValues = dailyData.map(d => d.napiecie).filter(v => v !== null);
                
                const lekTrend = this.linearRegression(dayNumbers.slice(0, lekValues.length), lekValues);
                const napiecieTrend = this.linearRegression(dayNumbers.slice(0, napiecieValues.length), napiecieValues);
                
                // Por贸wnanie po贸w
                const comparison = this.compareHalves(dailyData);
                
                // Stabilno ADHD
                const fokusFirst = comparison.firstHalf.fokus || 0;
                const fokusSecond = comparison.secondHalf.fokus || 0;
                const energiaFirst = comparison.firstHalf.energia || 0;
                const energiaSecond = comparison.secondHalf.energia || 0;
                
                const adhdStability = {
                    fokus: {
                        trend: fokusSecond >= fokusFirst - 0.5 ? 'stable' : 'declining',
                        firstHalf: fokusFirst,
                        secondHalf: fokusSecond
                    },
                    energia: {
                        trend: energiaSecond >= energiaFirst - 0.5 ? 'stable' : 'declining',
                        firstHalf: energiaFirst,
                        secondHalf: energiaSecond
                    }
                };
                
                // Wzorce dobowe
                const intradayData = this.aggregateByTimeOfDay(data);
                const avgByTime = {};
                Object.keys(intradayData).forEach(time => {
                    if (intradayData[time].lek) {
                        avgByTime[time] = intradayData[time].lek.mean;
                    }
                });
                
                const worstTime = Object.keys(avgByTime).reduce((a, b) => 
                    avgByTime[a] > avgByTime[b] ? a : b, Object.keys(avgByTime)[0]);
                const bestTime = Object.keys(avgByTime).reduce((a, b) => 
                    avgByTime[a] < avgByTime[b] ? a : b, Object.keys(avgByTime)[0]);
                
                // Okresy 3-dniowe
                const threeDayPeriods = this.compute3DayPeriods(dailyData);
                
                return {
                    period,
                    gadTrend: {
                        lek: { ...lekTrend, significant: lekTrend.pValue < 0.05 },
                        napiecie: { ...napiecieTrend, significant: napiecieTrend.pValue < 0.05 }
                    },
                    comparison,
                    adhdStability,
                    intradayPatterns: {
                        worstTimeOfDay: worstTime,
                        bestTimeOfDay: bestTime,
                        avgByTime: avgByTime
                    },
                    threeDayPeriods,
                    dailyData,
                    intradayData
                };
            }
        };
        
        /* ===== CHART RENDERER MODULE ===== */
        const ChartRenderer = {
            currentTheme: 'dark',
            
            // Plotly templates
            getTemplate: function() {
                const isDark = this.currentTheme === 'dark';
                return {
                    paper_bgcolor: 'transparent',
                    plot_bgcolor: 'transparent',
                    font: { 
                        color: isDark ? '#F1F5F9' : '#1E293B',
                        family: 'Outfit, sans-serif',
                        size: 12
                    },
                    xaxis: {
                        gridcolor: isDark ? '#334155' : '#E2E8F0',
                        linecolor: isDark ? '#334155' : '#E2E8F0',
                        color: isDark ? '#94A3B8' : '#64748B',
                        tickfont: { family: 'Outfit, sans-serif' }
                    },
                    yaxis: {
                        gridcolor: isDark ? '#334155' : '#E2E8F0',
                        linecolor: isDark ? '#334155' : '#E2E8F0',
                        color: isDark ? '#94A3B8' : '#64748B',
                        tickfont: { family: 'Outfit, sans-serif' }
                    }
                };
            },
            
            // Ustaw theme
            setTheme: function(theme) {
                this.currentTheme = theme;
                this.updateAllCharts();
            },
            
            // Aktualizuj wszystkie wykresy
            updateAllCharts: function() {
                const template = this.getTemplate();
                const chartIds = ['plot-gad', 'plot-intraday', 'plot-adhd', 'plot-stacked-area', 'plot-correlation', 'plot-sleep', 'plot-sleep-anxiety', 'plot-rolling-avg', 'plot-weekly', 'plot-radar', 'plot-positive-vs-negative', 'plot-metrics-by-time'];
                chartIds.forEach(id => {
                    const element = document.getElementById(id);
                    if (element && element.data) {
                        Plotly.relayout(id, template);
                    }
                });
            },
            
            // Wykres 1: GAD Trajectory
            renderGADTrajectory: function(containerId, dailyData, stats) {
                if (!dailyData || dailyData.length === 0) return;
                
                const dates = dailyData.map(d => {
                    const [day, month, year] = d.date.split('/');
                    return `${year}-${month}-${day}`;
                });
                
                const lekValues = dailyData.map(d => d.lek).filter(v => v !== null);
                const napiecieValues = dailyData.map(d => d.napiecie).filter(v => v !== null);
                
                // Trace 1: Lk
                const trace1 = {
                    x: dates,
                    y: lekValues,
                    type: 'scatter',
                    mode: 'lines+markers',
                    name: 'Lk (rednia dzienna)',
                    line: { color: '#EF4444', width: 3 },
                    marker: { size: 12, color: '#EF4444' },
                    hovertemplate: '<b>%{x|%d/%m/%Y}</b><br>Lk: %{y:.2f}<extra></extra>'
                };
                
                // Trace 2: Napicie
                const trace2 = {
                    x: dates,
                    y: napiecieValues,
                    type: 'scatter',
                    mode: 'lines+markers',
                    name: 'Napicie (rednia dzienna)',
                    line: { color: '#3B82F6', width: 3 },
                    marker: { size: 12, color: '#3B82F6', symbol: 'square' },
                    hovertemplate: '<b>%{x|%d/%m/%Y}</b><br>Napicie: %{y:.2f}<extra></extra>'
                };
                
                // Trend lines
                const dayNumbers = dailyData.map((_, i) => i + 1);
                let trace3 = null, trace4 = null;
                
                if (stats && stats.gadTrend) {
                    const lekTrend = stats.gadTrend.lek;
                    const napiecieTrend = stats.gadTrend.napiecie;
                    
                    if (lekTrend.slope !== undefined) {
                        const trendLek = dayNumbers.map(x => lekTrend.slope * x + lekTrend.intercept);
                        trace3 = {
                            x: dates,
                            y: trendLek,
                            type: 'scatter',
                            mode: 'lines',
                            name: `Trend Lku (slope=${lekTrend.slope.toFixed(3)}, p=${lekTrend.pValue.toFixed(3)})`,
                            line: { color: '#DC2626', width: 2, dash: 'dash' },
                            hovertemplate: 'Trend Lku: %{y:.2f}<extra></extra>'
                        };
                    }
                    
                    if (napiecieTrend.slope !== undefined) {
                        const trendNap = dayNumbers.map(x => napiecieTrend.slope * x + napiecieTrend.intercept);
                        trace4 = {
                            x: dates,
                            y: trendNap,
                            type: 'scatter',
                            mode: 'lines',
                            name: `Trend Napicia (slope=${napiecieTrend.slope.toFixed(3)}, p=${napiecieTrend.pValue.toFixed(3)})`,
                            line: { color: '#2563EB', width: 2, dash: 'dash' },
                            hovertemplate: 'Trend Napicia: %{y:.2f}<extra></extra>'
                        };
                    }
                }
                
                const traces = [trace1, trace2];
                if (trace3) traces.push(trace3);
                if (trace4) traces.push(trace4);
                
                // Shapes i annotations
                const shapes = [{
                    type: 'rect',
                    xref: 'paper',
                    yref: 'y',
                    x0: 0,
                    y0: 0,
                    x1: 1,
                    y1: 2,
                    fillcolor: 'rgba(16, 185, 129, 0.15)',
                    line: { width: 0 }
                }];
                
                const annotations = [{
                    x: dates[Math.floor(dates.length / 2)],
                    y: 0.5,
                    text: 'STREFA NISKIEGO LKU',
                    showarrow: false,
                    font: { color: '#10B981', size: 10 },
                    bgcolor: 'rgba(16, 185, 129, 0.2)',
                    bordercolor: '#10B981',
                    borderwidth: 1
                }];
                
                const template = this.getTemplate();
                const layout = {
                    ...template,
                    title: {
                        text: 'Trajektoria Leczenia GAD - Pregabalina',
                        font: { size: 16 }
                    },
                    xaxis: {
                        ...template.xaxis,
                        title: 'Data',
                        tickformat: '%d/%m',
                        tickangle: -45
                    },
                    yaxis: {
                        ...template.yaxis,
                        title: 'Poziom (skala 1-10)',
                        range: [0, 7]
                    },
                    shapes: shapes,
                    annotations: annotations,
                    legend: { 
                        x: 0.02,
                        y: 0.98,
                        bgcolor: this.currentTheme === 'dark' ? 'rgba(30, 41, 59, 0.95)' : 'rgba(255,255,255,0.95)',
                        bordercolor: template.xaxis.gridcolor,
                        borderwidth: 1
                    },
                    hovermode: 'x unified',
                    margin: { t: 60, r: 20, b: 60, l: 60 }
                };
                
                Plotly.newPlot(containerId, traces, layout, {responsive: true});
            },
            
            // Wykres 2: Intraday Profile (Simplified Bar Chart)
            renderIntradayProfile: function(containerId, intradayData) {
                if (!intradayData) return;
                
                const timeOrder = ['RANO', 'POUDNIE', 'POPOUDNIE', 'WIECZR'];
                const lekMeans = timeOrder.map(time => 
                    (intradayData[time] && intradayData[time].lek) ? intradayData[time].lek.mean : 0
                );
                const napiecieMeans = timeOrder.map(time => 
                    (intradayData[time] && intradayData[time].napiecie) ? intradayData[time].napiecie.mean : 0
                );
                
                const trace1 = {
                    x: timeOrder,
                    y: lekMeans,
                    type: 'bar',
                    name: 'redni Lk',
                    marker: { color: '#EF4444' },
                    text: lekMeans.map(v => v > 0 ? v.toFixed(1) : ''),
                    textposition: 'auto',
                };
                
                const trace2 = {
                    x: timeOrder,
                    y: napiecieMeans,
                    type: 'bar',
                    name: 'rednie Napicie',
                    marker: { color: '#3B82F6' },
                    text: napiecieMeans.map(v => v > 0 ? v.toFixed(1) : ''),
                    textposition: 'auto',
                };
                
                const template = this.getTemplate();
                const layout = {
                    ...template,
                    title: {
                        text: 'Nasilenie Objaw贸w vs Pora Dnia (rednie)',
                        font: { size: 16 }
                    },
                    xaxis: {
                        ...template.xaxis,
                        title: 'Pora dnia'
                    },
                    yaxis: {
                        ...template.yaxis,
                        title: 'redni Poziom (1-10)',
                        range: [0, 11]
                    },
                    barmode: 'group',
                    legend: { orientation: 'h', y: -0.2 },
                    margin: { t: 60, r: 20, b: 80, l: 60 }
                };
                
                Plotly.react(containerId, [trace1, trace2], layout, {responsive: true});
            },
            
            // Wykres 3: ADHD Stability
            renderADHDStability: function(containerId, dailyData) {
                if (!dailyData || dailyData.length === 0) return;
                
                const dates = dailyData.map(d => {
                    const [day, month, year] = d.date.split('/');
                    return `${year}-${month}-${day}`;
                });
                
                // Nie u偶ywamy filter bo to zmienia dugo tablicy
                const fokusValues = dailyData.map(d => d.fokus);
                const energiaValues = dailyData.map(d => d.energia);
                // Brain Fog to negatywny objaw - odwracamy: Klarowno = 11 - BrainFog (tak by 10->1, 1->10)
                const klarownoscValues = dailyData.map(d => (d.brainfog !== null && d.brainfog !== undefined) ? 11 - d.brainfog : null);
                
                const trace1 = {
                    x: dates,
                    y: fokusValues,
                    type: 'scatter',
                    mode: 'lines+markers',
                    name: 'Fokus',
                    connectgaps: true,
                    line: { color: '#10B981', width: 3 },
                    marker: { size: 10, color: '#10B981' }
                };
                
                const trace2 = {
                    x: dates,
                    y: energiaValues,
                    type: 'scatter',
                    mode: 'lines+markers',
                    name: 'Energia',
                    connectgaps: true,
                    line: { color: '#F59E0B', width: 3 },
                    marker: { size: 10, color: '#F59E0B', symbol: 'square' }
                };
                
                const trace3 = {
                    x: dates,
                    y: klarownoscValues,
                    type: 'scatter',
                    mode: 'lines+markers',
                    name: 'KLAROWNO',
                    connectgaps: true,
                    line: { color: '#8B5CF6', width: 3, dash: 'dot' },
                    marker: { size: 8, color: '#8B5CF6', symbol: 'triangle-up' },
                    opacity: 0.8
                };
                
                const template = this.getTemplate();
                const layout = {
                    ...template,
                    title: {
                        text: 'Kontrola Stabilnoci Leczenia ADHD (Elvanse 70mg)',
                        font: { size: 16, family: 'Outfit, sans-serif' }
                    },
                    xaxis: {
                        ...template.xaxis,
                        title: 'Data',
                        tickformat: '%d/%m',
                        tickangle: -45
                    },
                    yaxis: {
                        ...template.yaxis,
                        title: 'Poziom (skala 1-10)',
                        range: [0, 10]
                    },
                    shapes: [{
                        type: 'rect',
                        xref: 'paper',
                        yref: 'y',
                        x0: 0,
                        y0: 4,
                        x1: 1,
                        y1: 8,
                        fillcolor: 'rgba(16, 185, 129, 0.1)',
                        line: { width: 0 }
                    }],
                    annotations: [{
                        x: dates[Math.floor(dates.length / 2)],
                        y: 7.5,
                        text: 'STREFA OPTYMALNEGO FUNKCJONOWANIA',
                        showarrow: false,
                        font: { color: '#10B981', size: 10, family: 'Outfit, sans-serif' },
                        bgcolor: 'rgba(16, 185, 129, 0.2)',
                        bordercolor: '#10B981',
                        borderwidth: 1
                    }],
                    legend: { 
                        x: 0.02,
                        y: 0.02,
                        bgcolor: this.currentTheme === 'dark' ? 'rgba(30, 41, 59, 0.95)' : 'rgba(255,255,255,0.95)',
                        bordercolor: template.xaxis.gridcolor,
                        borderwidth: 1
                    },
                    hovermode: 'x unified',
                    margin: { t: 60, r: 20, b: 60, l: 60 }
                };
                
                Plotly.newPlot(containerId, [trace1, trace2, trace3], layout, {responsive: true});
            },
            
            // Wykres 4: Stacked Area Chart - Objawy w cigu dnia
            renderStackedAreaByTimeOfDay: function(containerId, data) {
                if (!data || data.length === 0) return;
                
                const timeOrder = ['RANO', 'POUDNIE', 'POPOUDNIE', 'WIECZR'];
                
                // Agreguj rednie dla ka偶dej pory dnia
                const aggregated = {};
                timeOrder.forEach(time => {
                    aggregated[time] = {
                        lek: [],
                        napiecie: [],
                        fokus: [],
                        energia: [],
                        brainfog: []
                    };
                });
                
                data.forEach(d => {
                    const time = d.PoraDnia;
                    if (aggregated[time]) {
                        if (d.Lk !== null) aggregated[time].lek.push(d.Lk);
                        if (d.Napicie !== null) aggregated[time].napiecie.push(d.Napicie);
                        if (d.Fokus !== null) aggregated[time].fokus.push(d.Fokus);
                        if (d.Energia !== null) aggregated[time].energia.push(d.Energia);
                        if (d.BrainFog !== null) aggregated[time].brainfog.push(d.BrainFog);
                    }
                });
                
                const calculateMean = (arr) => arr.length > 0 ? arr.reduce((a, b) => a + b, 0) / arr.length : 0;
                
                const lek = timeOrder.map(t => calculateMean(aggregated[t].lek));
                const napiecie = timeOrder.map(t => calculateMean(aggregated[t].napiecie));
                const fokus = timeOrder.map(t => calculateMean(aggregated[t].fokus));
                const energia = timeOrder.map(t => calculateMean(aggregated[t].energia));
                const klarownosc = timeOrder.map(t => {
                    const vals = aggregated[t].brainfog;
                    return vals.length > 0 ? calculateMean(vals.map(v => 11 - v)) : 0;
                });
                
                const trace1 = {
                    x: timeOrder,
                    y: lek,
                    name: 'Lk',
                    type: 'scatter',
                    mode: 'lines',
                    fill: 'tonexty',
                    fillcolor: 'rgba(239, 68, 68, 0.3)',
                    line: { color: '#EF4444', width: 2 },
                    stackgroup: 'one'
                };
                
                const trace2 = {
                    x: timeOrder,
                    y: napiecie,
                    name: 'Napicie',
                    type: 'scatter',
                    mode: 'lines',
                    fill: 'tonexty',
                    fillcolor: 'rgba(59, 130, 246, 0.3)',
                    line: { color: '#3B82F6', width: 2 },
                    stackgroup: 'one'
                };
                
                const trace3 = {
                    x: timeOrder,
                    y: fokus,
                    name: 'Fokus',
                    type: 'scatter',
                    mode: 'lines',
                    fill: 'tonexty',
                    fillcolor: 'rgba(16, 185, 129, 0.3)',
                    line: { color: '#10B981', width: 2 },
                    stackgroup: 'two'
                };
                
                const trace4 = {
                    x: timeOrder,
                    y: energia,
                    name: 'Energia',
                    type: 'scatter',
                    mode: 'lines',
                    fill: 'tonexty',
                    fillcolor: 'rgba(245, 158, 11, 0.3)',
                    line: { color: '#F59E0B', width: 2 },
                    stackgroup: 'two'
                };
                
                const trace5 = {
                    x: timeOrder,
                    y: klarownosc,
                    name: 'Klarowno',
                    type: 'scatter',
                    mode: 'lines',
                    fill: 'tonexty',
                    fillcolor: 'rgba(139, 92, 246, 0.3)',
                    line: { color: '#8B5CF6', width: 2 },
                    stackgroup: 'two'
                };
                
                const template = this.getTemplate();
                const layout = {
                    ...template,
                    title: {
                        text: 'Objawy w Cigu Dnia - Stacked Area',
                        font: { size: 16 }
                    },
                    xaxis: {
                        ...template.xaxis,
                        title: 'Pora Dnia',
                        type: 'category'
                    },
                    yaxis: {
                        ...template.yaxis,
                        title: 'Suma Wartoci',
                        range: [0, null]
                    },
                    legend: { orientation: 'h', y: -0.2 },
                    margin: { t: 60, r: 20, b: 60, l: 60 }
                };
                
                Plotly.newPlot(containerId, [trace1, trace2, trace3, trace4, trace5], layout, {responsive: true});
            },
            
            // Wykres 11: Pozytywne vs Negatywne Objawy
            renderPositiveVsNegative: function(containerId, dailyData) {
                if (!dailyData || dailyData.length === 0) return;
                
                // Oblicz rednie pozytywne i negatywne dla ka偶dego dnia
                const positiveScores = [];
                const negativeScores = [];
                const doses = [];
                const dates = [];
                
                dailyData.forEach(d => {
                    const positive = [];
                    const negative = [];
                    
                    if (d.fokus !== null) positive.push(d.fokus);
                    if (d.energia !== null) positive.push(d.energia);
                    if (d.brainfog !== null) positive.push(11 - d.brainfog); // Klarowno
                    
                    if (d.lek !== null) negative.push(d.lek);
                    if (d.napiecie !== null) negative.push(d.napiecie);
                    
                    if (positive.length > 0 && negative.length > 0) {
                        positiveScores.push(positive.reduce((a, b) => a + b, 0) / positive.length);
                        negativeScores.push(negative.reduce((a, b) => a + b, 0) / negative.length);
                        doses.push(d.pregabalinaMg || 0);
                        dates.push(d.date);
                    }
                });
                
                if (positiveScores.length === 0) return;
                
                // Kolor punkt贸w na podstawie dawki
                const maxDose = Math.max(...doses);
                const colors = doses.map(d => {
                    const ratio = maxDose > 0 ? d / maxDose : 0;
                    return `rgba(139, 92, 246, ${0.3 + ratio * 0.7})`;
                });
                
                const trace1 = {
                    x: positiveScores,
                    y: negativeScores,
                    type: 'scatter',
                    mode: 'markers',
                    name: 'Dni',
                    marker: {
                        size: 10,
                        color: colors,
                        line: { color: '#8B5CF6', width: 1 }
                    },
                    text: dates,
                    hovertemplate: 'Pozytywne: %{x:.2f}<br>Negatywne: %{y:.2f}<br>Data: %{text}<extra></extra>'
                };
                
                // Linia regresji
                let trace2 = null;
                if (positiveScores.length > 1) {
                    const regression = StatsEngine.linearRegression(positiveScores, negativeScores);
                    if (regression && !isNaN(regression.slope)) {
                        const xMin = Math.min(...positiveScores);
                        const xMax = Math.max(...positiveScores);
                        const yMin = regression.slope * xMin + regression.intercept;
                        const yMax = regression.slope * xMax + regression.intercept;
                        
                        trace2 = {
                            x: [xMin, xMax],
                            y: [yMin, yMax],
                            type: 'scatter',
                            mode: 'lines',
                            name: `Regresja (r=${regression.r.toFixed(2)})`,
                            line: { color: '#DC2626', width: 2, dash: 'dash' },
                            hovertemplate: 'Regresja: y = %{y:.2f}<extra></extra>'
                        };
                    }
                }
                
                const traces = [trace1];
                if (trace2) traces.push(trace2);
                
                const template = this.getTemplate();
                const layout = {
                    ...template,
                    title: {
                        text: 'Korelacja: Objawy Pozytywne vs Negatywne',
                        font: { size: 16 }
                    },
                    xaxis: {
                        ...template.xaxis,
                        title: 'rednia Objaw贸w Pozytywnych (Fokus + Energia + Klarowno)',
                        range: [0, 10]
                    },
                    yaxis: {
                        ...template.yaxis,
                        title: 'rednia Objaw贸w Negatywnych (Lk + Napicie)',
                        range: [0, 10]
                    },
                    legend: { orientation: 'h', y: -0.2 },
                    margin: { t: 60, r: 20, b: 60, l: 60 }
                };
                
                Plotly.newPlot(containerId, traces, layout, {responsive: true});
            },
            
            // Wykres 12: Wszystkie Metryki per Pora Dnia
            renderMetricsByTimeOfDay: function(containerId, data) {
                if (!data || data.length === 0) return;
                
                const timeOrder = ['RANO', 'POUDNIE', 'POPOUDNIE', 'WIECZR'];
                
                // Agreguj rednie dla ka偶dej pory dnia
                const aggregated = {};
                timeOrder.forEach(time => {
                    aggregated[time] = {
                        lek: [],
                        napiecie: [],
                        fokus: [],
                        energia: [],
                        brainfog: []
                    };
                });
                
                data.forEach(d => {
                    const time = d.PoraDnia;
                    if (aggregated[time]) {
                        if (d.Lk !== null) aggregated[time].lek.push(d.Lk);
                        if (d.Napicie !== null) aggregated[time].napiecie.push(d.Napicie);
                        if (d.Fokus !== null) aggregated[time].fokus.push(d.Fokus);
                        if (d.Energia !== null) aggregated[time].energia.push(d.Energia);
                        if (d.BrainFog !== null) aggregated[time].brainfog.push(d.BrainFog);
                    }
                });
                
                const calculateMean = (arr) => arr.length > 0 ? arr.reduce((a, b) => a + b, 0) / arr.length : 0;
                
                const lek = timeOrder.map(t => calculateMean(aggregated[t].lek));
                const napiecie = timeOrder.map(t => calculateMean(aggregated[t].napiecie));
                const fokus = timeOrder.map(t => calculateMean(aggregated[t].fokus));
                const energia = timeOrder.map(t => calculateMean(aggregated[t].energia));
                const klarownosc = timeOrder.map(t => {
                    const vals = aggregated[t].brainfog;
                    return vals.length > 0 ? calculateMean(vals.map(v => 11 - v)) : 0;
                });
                
                const trace1 = {
                    x: timeOrder,
                    y: lek,
                    type: 'bar',
                    name: 'Lk',
                    marker: { color: '#EF4444' },
                    text: lek.map(v => v > 0 ? v.toFixed(1) : ''),
                    textposition: 'auto'
                };
                
                const trace2 = {
                    x: timeOrder,
                    y: napiecie,
                    type: 'bar',
                    name: 'Napicie',
                    marker: { color: '#3B82F6' },
                    text: napiecie.map(v => v > 0 ? v.toFixed(1) : ''),
                    textposition: 'auto'
                };
                
                const trace3 = {
                    x: timeOrder,
                    y: fokus,
                    type: 'bar',
                    name: 'Fokus',
                    marker: { color: '#10B981' },
                    text: fokus.map(v => v > 0 ? v.toFixed(1) : ''),
                    textposition: 'auto'
                };
                
                const trace4 = {
                    x: timeOrder,
                    y: energia,
                    type: 'bar',
                    name: 'Energia',
                    marker: { color: '#F59E0B' },
                    text: energia.map(v => v > 0 ? v.toFixed(1) : ''),
                    textposition: 'auto'
                };
                
                const trace5 = {
                    x: timeOrder,
                    y: klarownosc,
                    type: 'bar',
                    name: 'Klarowno',
                    marker: { color: '#8B5CF6' },
                    text: klarownosc.map(v => v > 0 ? v.toFixed(1) : ''),
                    textposition: 'auto'
                };
                
                const template = this.getTemplate();
                const layout = {
                    ...template,
                    title: {
                        text: 'Wszystkie Metryki per Pora Dnia',
                        font: { size: 16 }
                    },
                    xaxis: {
                        ...template.xaxis,
                        title: 'Pora Dnia',
                        type: 'category'
                    },
                    yaxis: {
                        ...template.yaxis,
                        title: 'redni Poziom (1-10)',
                        range: [0, 10]
                    },
                    barmode: 'group',
                    legend: { orientation: 'h', y: -0.2 },
                    margin: { t: 60, r: 20, b: 60, l: 60 }
                };
                
                Plotly.newPlot(containerId, [trace1, trace2, trace3, trace4, trace5], layout, {responsive: true});
            },
            
            // Wykres 5: Correlation Table (Readable grid)
            renderCorrelationTable: function(containerId, correlationData) {
                const container = document.getElementById('correlation-table-container');
                if (!container || !correlationData || !correlationData.matrix) return;
                
                const { matrix, labels } = correlationData;
                
                let html = `
                    <table class="correlation-grid" style="width: 100%; border-collapse: collapse; font-size: 0.8rem; text-align: center; color: var(--text-primary);">
                        <thead>
                            <tr>
                                <th style="padding: 12px 8px; border: 1px solid var(--border); background: var(--bg-hover);">Zmienna</th>
                                ${labels.map(l => `<th style="padding: 12px 8px; border: 1px solid var(--border); background: var(--bg-hover);">${l}</th>`).join('')}
                            </tr>
                        </thead>
                        <tbody>
                `;
                
                matrix.forEach((row, i) => {
                    html += `<tr><td style="padding: 12px 8px; border: 1px solid var(--border); background: var(--bg-hover); font-weight: 600; text-align: left;">${labels[i]}</td>`;
                    row.forEach((val, j) => {
                        let bgColor = 'transparent';
                        let textColor = 'inherit';
                        let opacity = Math.abs(val);
                        
                        if (val !== null && i >= j) { // Show lower triangle only
                            if (val > 0.3) bgColor = `rgba(16, 185, 129, ${opacity * 0.6})`;
                            else if (val < -0.3) bgColor = `rgba(239, 68, 68, ${opacity * 0.6})`;
                            
                            if (opacity > 0.6) textColor = '#fff';
                        } else if (i < j) {
                            val = null;
                        }
                        
                        html += `
                            <td style="padding: 12px 8px; border: 1px solid var(--border); background: ${bgColor}; color: ${textColor};">
                                ${val !== null ? val.toFixed(2) : ''}
                            </td>
                        `;
                    });
                    html += '</tr>';
                });
                
                html += '</tbody></table>';
                container.innerHTML = html;
                
                this.updateCorrelationSummary(correlationData);
            },
            
            // Wykres 6: Sleep Analysis (Time vs Quality)
            renderSleepChart: function(containerId, dailyData) {
                if (!dailyData || dailyData.length === 0) return;
                
                const dates = dailyData.map(d => {
                    const [day, month, year] = d.date.split('/');
                    return `${year}-${month}-${day}`;
                });
                
                const trace1 = {
                    x: dates,
                    y: dailyData.map(d => d.godzinySnu),
                    type: 'bar',
                    name: 'Godziny Snu',
                    marker: { color: 'rgba(59, 130, 246, 0.5)' },
                    hovertemplate: '%{y}h<extra></extra>'
                };
                
                const trace2 = {
                    x: dates,
                    y: dailyData.map(d => d.jakoscSnu),
                    type: 'scatter',
                    mode: 'lines+markers',
                    name: 'Jako Snu (1-10)',
                    yaxis: 'y2',
                    line: { color: '#8B5CF6', width: 3 },
                    marker: { size: 10, color: '#8B5CF6' },
                    hovertemplate: 'Jako: %{y}<extra></extra>'
                };
                
                const template = this.getTemplate();
                const layout = {
                    ...template,
                    title: { text: 'Analiza Snu: Czas i Jako', font: { size: 16 } },
                    xaxis: { ...template.xaxis, title: 'Data', tickformat: '%d/%m' },
                    yaxis: { ...template.yaxis, title: 'Godziny', range: [0, 12] },
                    yaxis2: {
                        title: 'Jako (1-10)',
                        overlaying: 'y',
                        side: 'right',
                        range: [0, 11],
                        showgrid: false,
                        color: '#8B5CF6'
                    },
                    legend: { orientation: 'h', y: -0.2 },
                    margin: { t: 60, r: 60, b: 80, l: 60 }
                };
                
                Plotly.newPlot(containerId, [trace1, trace2], layout, {responsive: true});
            },
            
            // Wykres 7: Sen vs Lk Nastpnego Dnia (Scatter z regresj)
            renderSleepVsAnxiety: function(containerId, dailyData) {
                if (!dailyData || dailyData.length < 2) return;
                
                // Przygotuj dane: jako snu dnia N vs lk dnia N+1
                const sleepQuality = [];
                const nextDayAnxiety = [];
                const nextDayTension = [];
                
                for (let i = 0; i < dailyData.length - 1; i++) {
                    const today = dailyData[i];
                    const tomorrow = dailyData[i + 1];
                    
                    if (today.jakoscSnu !== null && tomorrow.lek !== null) {
                        sleepQuality.push(today.jakoscSnu);
                        nextDayAnxiety.push(tomorrow.lek);
                    }
                    if (today.jakoscSnu !== null && tomorrow.napiecie !== null) {
                        nextDayTension.push(tomorrow.napiecie);
                    }
                }
                
                const trace1 = {
                    x: sleepQuality,
                    y: nextDayAnxiety,
                    type: 'scatter',
                    mode: 'markers',
                    name: 'Lk (dzie N+1)',
                    marker: { color: '#EF4444', size: 10, opacity: 0.7 },
                    hovertemplate: 'Sen: %{x}<br>Lk: %{y}<extra></extra>'
                };
                
                const trace2 = {
                    x: sleepQuality,
                    y: nextDayTension,
                    type: 'scatter',
                    mode: 'markers',
                    name: 'Napicie (dzie N+1)',
                    marker: { color: '#3B82F6', size: 10, opacity: 0.7, symbol: 'square' },
                    hovertemplate: 'Sen: %{x}<br>Napicie: %{y}<extra></extra>'
                };
                
                // Linia regresji dla Lku
                let trace3 = null;
                if (sleepQuality.length > 0 && nextDayAnxiety.length > 0) {
                    const regression = StatsEngine.linearRegression(sleepQuality, nextDayAnxiety);
                    if (regression && !isNaN(regression.slope)) {
                        const xMin = Math.min(...sleepQuality);
                        const xMax = Math.max(...sleepQuality);
                        const yMin = regression.slope * xMin + regression.intercept;
                        const yMax = regression.slope * xMax + regression.intercept;
                        
                        trace3 = {
                            x: [xMin, xMax],
                            y: [yMin, yMax],
                            type: 'scatter',
                            mode: 'lines',
                            name: `Regresja Lku (r=${regression.r.toFixed(2)})`,
                            line: { color: '#DC2626', width: 2, dash: 'dash' },
                            hovertemplate: 'Regresja: y = %{y:.2f}<extra></extra>'
                        };
                    }
                }
                
                const traces = [trace1, trace2];
                if (trace3) traces.push(trace3);
                
                const template = this.getTemplate();
                const layout = {
                    ...template,
                    title: {
                        text: 'Wpyw Jakoci Snu na Objawy Nastpnego Dnia',
                        font: { size: 16 }
                    },
                    xaxis: {
                        ...template.xaxis,
                        title: 'Jako Snu (dzie N)',
                        range: [0, 11]
                    },
                    yaxis: {
                        ...template.yaxis,
                        title: 'Poziom Objaw贸w (dzie N+1)',
                        range: [0, 10]
                    },
                    legend: { orientation: 'h', y: -0.2 },
                    margin: { t: 60, r: 20, b: 60, l: 60 }
                };
                
                Plotly.newPlot(containerId, traces, layout, {responsive: true});
            },
            
            // Wykres 8: Rolling Average (3-day MA)
            renderRollingAverage: function(containerId, dailyData) {
                if (!dailyData || dailyData.length < 3) return;
                
                const dates = dailyData.map(d => {
                    const [day, month, year] = d.date.split('/');
                    return `${year}-${month}-${day}`;
                });
                
                // Oblicz 3-day moving average
                const calculateMA = (values, window = 3) => {
                    const ma = [];
                    for (let i = 0; i < values.length; i++) {
                        const start = Math.max(0, i - window + 1);
                        const windowValues = values.slice(start, i + 1).filter(v => v !== null);
                        ma.push(windowValues.length > 0 ? windowValues.reduce((a, b) => a + b, 0) / windowValues.length : null);
                    }
                    return ma;
                };
                
                const lekRaw = dailyData.map(d => d.lek);
                const lekMA = calculateMA(lekRaw);
                const napiecieRaw = dailyData.map(d => d.napiecie);
                const napiecieMA = calculateMA(napiecieRaw);
                
                const trace1 = {
                    x: dates,
                    y: lekRaw,
                    type: 'scatter',
                    mode: 'markers',
                    name: 'Lk (surowe)',
                    marker: { color: '#EF4444', size: 6, opacity: 0.4 },
                    hovertemplate: 'Lk: %{y:.2f}<extra></extra>'
                };
                
                const trace2 = {
                    x: dates,
                    y: lekMA,
                    type: 'scatter',
                    mode: 'lines',
                    name: 'Lk (3-dniowa rednia)',
                    line: { color: '#EF4444', width: 3 },
                    hovertemplate: 'rednia: %{y:.2f}<extra></extra>'
                };
                
                const trace3 = {
                    x: dates,
                    y: napiecieRaw,
                    type: 'scatter',
                    mode: 'markers',
                    name: 'Napicie (surowe)',
                    marker: { color: '#3B82F6', size: 6, opacity: 0.4, symbol: 'square' },
                    hovertemplate: 'Napicie: %{y:.2f}<extra></extra>'
                };
                
                const trace4 = {
                    x: dates,
                    y: napiecieMA,
                    type: 'scatter',
                    mode: 'lines',
                    name: 'Napicie (3-dniowa rednia)',
                    line: { color: '#3B82F6', width: 3 },
                    hovertemplate: 'rednia: %{y:.2f}<extra></extra>'
                };
                
                const template = this.getTemplate();
                const layout = {
                    ...template,
                    title: {
                        text: 'Trend z Wygadzeniem (3-dniowa rednia Kroczca)',
                        font: { size: 16 }
                    },
                    xaxis: {
                        ...template.xaxis,
                        title: 'Data',
                        tickformat: '%d/%m'
                    },
                    yaxis: {
                        ...template.yaxis,
                        title: 'Poziom (skala 1-10)',
                        range: [0, 10]
                    },
                    legend: { orientation: 'h', y: -0.2 },
                    margin: { t: 60, r: 20, b: 60, l: 60 }
                };
                
                Plotly.newPlot(containerId, [trace1, trace2, trace3, trace4], layout, {responsive: true});
            },
            
            // Wykres 9: Por贸wnanie Tygodni
            renderWeeklyComparison: function(containerId, dailyData) {
                if (!dailyData || dailyData.length === 0) return;
                
                // Grupuj dane po tygodniach
                const weeks = {};
                dailyData.forEach(d => {
                    const [day, month, year] = d.date.split('/').map(Number);
                    const date = new Date(year, month - 1, day);
                    const weekNum = Math.ceil((date - new Date(year, 0, 1)) / (7 * 24 * 60 * 60 * 1000));
                    const weekKey = `Tydzie ${weekNum}`;
                    
                    if (!weeks[weekKey]) {
                        weeks[weekKey] = { lek: [], napiecie: [], fokus: [], energia: [] };
                    }
                    
                    if (d.lek !== null) weeks[weekKey].lek.push(d.lek);
                    if (d.napiecie !== null) weeks[weekKey].napiecie.push(d.napiecie);
                    if (d.fokus !== null) weeks[weekKey].fokus.push(d.fokus);
                    if (d.energia !== null) weeks[weekKey].energia.push(d.energia);
                });
                
                const weekLabels = Object.keys(weeks).sort();
                const lekMeans = weekLabels.map(w => {
                    const vals = weeks[w].lek;
                    return vals.length > 0 ? vals.reduce((a, b) => a + b, 0) / vals.length : 0;
                });
                const napiecieMeans = weekLabels.map(w => {
                    const vals = weeks[w].napiecie;
                    return vals.length > 0 ? vals.reduce((a, b) => a + b, 0) / vals.length : 0;
                });
                const fokusMeans = weekLabels.map(w => {
                    const vals = weeks[w].fokus;
                    return vals.length > 0 ? vals.reduce((a, b) => a + b, 0) / vals.length : 0;
                });
                const energiaMeans = weekLabels.map(w => {
                    const vals = weeks[w].energia;
                    return vals.length > 0 ? vals.reduce((a, b) => a + b, 0) / vals.length : 0;
                });
                
                const trace1 = {
                    x: weekLabels,
                    y: lekMeans,
                    type: 'bar',
                    name: 'Lk',
                    marker: { color: '#EF4444' },
                    text: lekMeans.map(v => v > 0 ? v.toFixed(1) : ''),
                    textposition: 'auto'
                };
                
                const trace2 = {
                    x: weekLabels,
                    y: napiecieMeans,
                    type: 'bar',
                    name: 'Napicie',
                    marker: { color: '#3B82F6' },
                    text: napiecieMeans.map(v => v > 0 ? v.toFixed(1) : ''),
                    textposition: 'auto'
                };
                
                const trace3 = {
                    x: weekLabels,
                    y: fokusMeans,
                    type: 'bar',
                    name: 'Fokus',
                    marker: { color: '#10B981' },
                    text: fokusMeans.map(v => v > 0 ? v.toFixed(1) : ''),
                    textposition: 'auto'
                };
                
                const trace4 = {
                    x: weekLabels,
                    y: energiaMeans,
                    type: 'bar',
                    name: 'Energia',
                    marker: { color: '#F59E0B' },
                    text: energiaMeans.map(v => v > 0 ? v.toFixed(1) : ''),
                    textposition: 'auto'
                };
                
                const template = this.getTemplate();
                const layout = {
                    ...template,
                    title: {
                        text: 'Por贸wnanie Tygodniowe - rednie Wartoci',
                        font: { size: 16 }
                    },
                    xaxis: {
                        ...template.xaxis,
                        title: 'Tydzie'
                    },
                    yaxis: {
                        ...template.yaxis,
                        title: 'redni Poziom (1-10)',
                        range: [0, 10]
                    },
                    barmode: 'group',
                    legend: { orientation: 'h', y: -0.2 },
                    margin: { t: 60, r: 20, b: 60, l: 60 }
                };
                
                Plotly.newPlot(containerId, [trace1, trace2, trace3, trace4], layout, {responsive: true});
            },
            
            // Wykres 10: Radar Profilu Dnia
            renderDayRadar: function(containerId, dailyData) {
                if (!dailyData || dailyData.length === 0) return;
                
                // Oblicz rednie dla wszystkich metryk
                const metrics = {
                    'Lk': dailyData.map(d => d.lek).filter(v => v !== null),
                    'Napicie': dailyData.map(d => d.napiecie).filter(v => v !== null),
                    'Fokus': dailyData.map(d => d.fokus).filter(v => v !== null),
                    'Energia': dailyData.map(d => d.energia).filter(v => v !== null),
                    'Klarowno': dailyData.map(d => d.brainfog !== null ? 11 - d.brainfog : null).filter(v => v !== null),
                    'Jako Snu': dailyData.map(d => d.jakoscSnu).filter(v => v !== null)
                };
                
                const means = {};
                Object.keys(metrics).forEach(key => {
                    const vals = metrics[key];
                    means[key] = vals.length > 0 ? vals.reduce((a, b) => a + b, 0) / vals.length : 0;
                });
                
                // Przygotuj dane dla radar chart
                const theta = Object.keys(means);
                const r = theta.map(k => means[k]);
                
                // Plotly scatterpolar wymaga zamknitego ksztatu (pierwszy punkt na kocu)
                const thetaClosed = [...theta, theta[0]];
                const rClosed = [...r, r[0]];
                
                const trace = {
                    type: 'scatterpolar',
                    r: rClosed,
                    theta: thetaClosed,
                    fill: 'toself',
                    name: 'redni Profil',
                    line: { color: '#8B5CF6', width: 3 },
                    marker: { color: '#8B5CF6', size: 8 },
                    hovertemplate: '%{theta}: %{r:.2f}<extra></extra>'
                };
                
                const template = this.getTemplate();
                const layout = {
                    ...template,
                    polar: {
                        radialaxis: {
                            visible: true,
                            range: [0, 10],
                            tickfont: { family: 'Outfit, sans-serif', size: 11 },
                            tickmode: 'linear',
                            tick0: 0,
                            dtick: 2
                        },
                        angularaxis: {
                            tickfont: { family: 'Outfit, sans-serif', size: 11 },
                            rotation: 90,
                            direction: 'counterclockwise'
                        }
                    },
                    title: {
                        text: 'Radar Profilu - Holistyczny Widok',
                        font: { size: 16, family: 'Outfit, sans-serif' }
                    },
                    showlegend: false,
                    margin: { t: 80, r: 20, b: 20, l: 20 }
                };
                
                // Purge i stw贸rz nowy wykres
                Plotly.purge(containerId);
                Plotly.newPlot(containerId, [trace], layout, {responsive: true});
            },
            
            updateCorrelationSummary: function(correlationData) {
                const summaryDiv = document.getElementById('correlation-text-summary');
                if (!summaryDiv) return;
                
                const { matrix, labels } = correlationData;
                const correlations = [];
                
                for (let i = 0; i < matrix.length; i++) {
                    for (let j = 0; j < i; j++) {
                        const val = matrix[i][j];
                        if (Math.abs(val) >= 0.3) {
                            correlations.push({
                                labels: [labels[i], labels[j]],
                                value: val
                            });
                        }
                    }
                }
                
                if (correlations.length === 0) {
                    summaryDiv.innerHTML = '<p>Brak istotnych statystycznie korelacji (|r| >= 0.3).</p>';
                    return;
                }
                
                // Sortuj od najsilniejszych
                correlations.sort((a, b) => Math.abs(b.value) - Math.abs(a.value));
                
                let html = '<ul style="list-style: none; padding: 0;">';
                correlations.slice(0, 6).forEach(c => {
                    const direction = c.value > 0 ? 'dodatnia' : 'ujemna';
                    const strengthValue = Math.abs(c.value);
                    const strength = strengthValue > 0.7 ? 'silna' : (strengthValue > 0.5 ? 'umiarkowana' : 'saba');
                    const color = c.value > 0 ? 'var(--accent-green)' : 'var(--accent-red)';
                    
                    // Interpretacja kliniczna
                    let interpretation = '';
                    if (c.labels.includes('Sen (Jako)') && (c.labels.includes('Lk') || c.labels.includes('Napicie'))) {
                        interpretation = c.value < 0 ? ' (Lepszy sen wi偶e si z ni偶szym lkiem/napiciem)' : '';
                    } else if (c.labels.includes('Pregabalina') && (c.labels.includes('Lk') || c.labels.includes('Napicie'))) {
                        interpretation = c.value < 0 ? ' (Wy偶sza dawka koreluje z redukcj objaw贸w)' : '';
                    }
                    
                    html += `<li style="margin-bottom: 8px; line-height: 1.4;">
                         Midzy <strong>${c.labels[0]}</strong> a <strong>${c.labels[1]}</strong> wystpuje ${strength} korelacja ${direction} 
                        (<strong style="color: ${color}">r = ${c.value.toFixed(2)}</strong>).${interpretation}
                    </li>`;
                });
                html += '</ul>';
                
                summaryDiv.innerHTML = html;
            },
            
            // Render wszystkich wykres贸w
            renderAllCharts: function(data, stats) {
                if (!data || data.length === 0) return;
                
                const dailyData = stats.dailyData || StatsEngine.aggregateDaily(data);
                const intradayData = stats.intradayData || StatsEngine.aggregateByTimeOfDay(data);
                
                // 1. Trajektoria
                this.renderGADTrajectory('plot-gad', dailyData, stats);
                
                // 2. Profil Dobowy
                this.renderIntradayProfile('plot-intraday', intradayData);
                
                // 3. ADHD
                this.renderADHDStability('plot-adhd', dailyData);
                
                // 4. Stacked Area (zamiast heatmapy)
                this.renderStackedAreaByTimeOfDay('plot-stacked-area', data);
                
                // 5. Sleep Analysis
                this.renderSleepChart('plot-sleep', dailyData);

                // 6. Korelacje (Tabela)
                const variables = ['lek', 'napiecie', 'jakoscSnu', 'brainfog', 'energia', 'fokus', 'pregabalina'];
                const corrData = StatsEngine.correlationMatrix(data, variables);
                const labels = ['Lk', 'Napicie', 'Sen (Jako)', 'Klarowno', 'Energia', 'Fokus', 'Pregabalina'];
                this.renderCorrelationTable('correlation-table-container', { matrix: corrData.matrix, labels: labels });

                // 7. Sen vs Lk Nastpnego Dnia
                this.renderSleepVsAnxiety('plot-sleep-anxiety', dailyData);

                // 8. Rolling Average
                this.renderRollingAverage('plot-rolling-avg', dailyData);

                // 9. Por贸wnanie Tygodniowe
                this.renderWeeklyComparison('plot-weekly', dailyData);

                // 10. Radar Profilu
                this.renderDayRadar('plot-radar', dailyData);

                // 11. Pozytywne vs Negatywne
                this.renderPositiveVsNegative('plot-positive-vs-negative', dailyData);

                // 12. Metryki per Pora Dnia
                this.renderMetricsByTimeOfDay('plot-metrics-by-time', data);
            },
            
            // Eksport do PNG
            exportChart: function(containerId, filename) {
                if (typeof Plotly === 'undefined') {
                    console.error('Plotly nie jest zaadowany');
                    return;
                }
                
                Plotly.downloadImage(containerId, {
                    format: 'png',
                    width: 1200,
                    height: 600,
                    filename: filename || 'chart'
                });
            }
        };
        
        /* ===== TABLE MANAGER MODULE ===== */
        const TableManager = {
            currentData: [],
            sortColumn: 'Data',
            sortDirection: 'desc',
            filters: { dateFrom: null, dateTo: null, timeOfDay: null },
            
            // Render tabeli
            render: function(containerId, data) {
                if (!data || data.length === 0) {
                    const tbody = document.querySelector(`#${containerId} tbody`);
                    if (tbody) {
                        tbody.innerHTML = '<tr><td colspan="9" class="text-center" style="padding: 40px; color: var(--text-secondary);">Brak danych. Zaimportuj dane w zakadce "Import Danych".</td></tr>';
                    }
                    return;
                }
                
                this.currentData = data;
                this.applyFiltersAndSort();
            },
            
            // Zastosuj filtry i sortowanie
            applyFiltersAndSort: function() {
                let filtered = [...this.currentData];
                
                // Filtry
                if (this.filters.dateFrom) {
                    filtered = filtered.filter(item => {
                        const [day, month, year] = item.Data.split('/');
                        const itemDate = new Date(`${year}-${month}-${day}`);
                        const filterDate = new Date(this.filters.dateFrom);
                        return itemDate >= filterDate;
                    });
                }
                
                if (this.filters.dateTo) {
                    filtered = filtered.filter(item => {
                        const [day, month, year] = item.Data.split('/');
                        const itemDate = new Date(`${year}-${month}-${day}`);
                        const filterDate = new Date(this.filters.dateTo);
                        return itemDate <= filterDate;
                    });
                }
                
                if (this.filters.timeOfDay) {
                    filtered = filtered.filter(item => item.PoraDnia === this.filters.timeOfDay);
                }
                
                // Sortowanie
                filtered.sort((a, b) => {
                    let aVal = a[this.sortColumn];
                    let bVal = b[this.sortColumn];
                    
                    if (this.sortColumn === 'Data') {
                        const [aDay, aMonth, aYear] = aVal.split('/');
                        const [bDay, bMonth, bYear] = bVal.split('/');
                        aVal = new Date(`${aYear}-${aMonth}-${aDay}`);
                        bVal = new Date(`${bYear}-${bMonth}-${bDay}`);
                    } else if (this.sortColumn === 'Czas') {
                        // Por贸wnaj jako string HH:MM
                    } else {
                        aVal = parseFloat(aVal) || 0;
                        bVal = parseFloat(bVal) || 0;
                    }
                    
                    if (aVal < bVal) return this.sortDirection === 'asc' ? -1 : 1;
                    if (aVal > bVal) return this.sortDirection === 'asc' ? 1 : -1;
                    return 0;
                });
                
                // Render
                this.renderTable(filtered);
            },
            
            // Render tabeli HTML
            renderTable: function(data) {
                const tbody = document.querySelector('#data-table tbody');
                if (!tbody) return;
                
                tbody.innerHTML = data.map(item => {
                    const lek = this.formatCell(item.Lk, 'Lk');
                    const napiecie = this.formatCell(item.Napicie, 'Napicie');
                    const fokus = this.formatCell(item.Fokus, 'Fokus');
                    const energia = this.formatCell(item.Energia, 'Energia');
                    const brainFog = this.formatCell(item.BrainFog, 'BrainFog');
                    const pregabalin = item.Pregabalina_Dawka ? `${item.Pregabalina_Dawka}mg` : '-';
                    
                    return `
                        <tr>
                            <td>${item.Data}</td>
                            <td>${item.Czas}</td>
                            <td>${lek}</td>
                            <td>${napiecie}</td>
                            <td>${fokus}</td>
                            <td>${energia}</td>
                            <td>${brainFog}</td>
                            <td>${item.PoraDnia}</td>
                            <td>${pregabalin}</td>
                        </tr>
                    `;
                }).join('');
            },
            
            // Formatowanie kom贸rki
            formatCell: function(value, column) {
                if (value === null || value === undefined) return '-';
                
                const num = parseFloat(value);
                if (isNaN(num)) return value;
                
                // Kolorowanie dla metryk
                if (['Lk', 'Napicie', 'BrainFog'].includes(column)) {
                    if (num <= 2) return `<span style="color: var(--accent-green);">${num}</span>`;
                    if (num >= 7) return `<span style="color: var(--accent-red);">${num}</span>`;
                } else if (['Fokus', 'Energia'].includes(column)) {
                    if (num >= 7) return `<span style="color: var(--accent-green);">${num}</span>`;
                    if (num <= 3) return `<span style="color: var(--accent-red);">${num}</span>`;
                }
                
                return num;
            },
            
            // Sortowanie
            sort: function(column) {
                if (this.sortColumn === column) {
                    this.sortDirection = this.sortDirection === 'asc' ? 'desc' : 'asc';
                } else {
                    this.sortColumn = column;
                    this.sortDirection = 'asc';
                }
                this.applyFiltersAndSort();
            },
            
            // Filtrowanie
            filter: function(filters) {
                this.filters = { ...this.filters, ...filters };
                this.applyFiltersAndSort();
            }
        };
        
        /* ===== DOCTOR REPORT MODULE ===== */
        const DoctorReport = {
            // Generuj peny raport HTML
            generate: function(data, stats) {
                if (!data || data.length === 0 || !stats) {
                    return '<p style="color: var(--text-secondary); text-align: center; padding: 40px;">Brak danych. Zaimportuj dane w zakadce "Import Danych", aby wygenerowa raport.</p>';
                }
                
                const html = `
                    ${this.renderPatientInfo(stats)}
                    ${this.render3DayPeriodsTable(stats)}
                    ${this.renderGADEffectiveness(stats)}
                    ${this.renderADHDStability(stats)}
                    ${this.renderIntradayPatterns(stats)}
                    ${this.renderConclusions(stats)}
                `;
                
                return html;
            },
            
            // Sekcja: Informacje o pacjencie
            renderPatientInfo: function(stats) {
                const period = stats.period || {};
                return `
                    <div class="report-section">
                        <h3>Informacje o Pacjencie</h3>
                        <p><strong>Okres obserwacji:</strong> <strong>${period.start || '-'}</strong> - <strong>${period.end || '-'}</strong></p>
                        <p><strong>Liczba dni:</strong> <strong>${period.days || 0}</strong></p>
                        <p><strong>Liczba pomiar贸w:</strong> <strong>${period.measurements || 0}</strong></p>
                        <p><strong>rednia pomiar贸w/dzie:</strong> <strong>${period.measurements && period.days ? (period.measurements / period.days).toFixed(1) : '-'}</strong></p>
                        <p><strong>Leki:</strong> Elvanse 70mg/d + Pregabalina 225mg/d (75mg rano + 150mg wieczorem)</p>
                    </div>
                `;
            },
            
            // Sekcja: Tabela okres贸w 3-dniowych
            render3DayPeriodsTable: function(stats) {
                const periods = stats.threeDayPeriods || [];
                if (periods.length === 0) return '';
                
                const metricLabels = {
                    'lek': 'Lk',
                    'napiecie': 'Napicie',
                    'fokus': 'Fokus',
                    'energia': 'Energia',
                    'brainfog': 'Klarowno',
                    'jakoscSnu': 'Jako Snu'
                };
                
                const formatValue = (val) => val !== null && val !== undefined ? val.toFixed(2) : '-';
                const formatTrend = (trend) => {
                    if (trend === null || trend === undefined || isNaN(trend)) return '-';
                    const sign = trend > 0 ? '+' : '';
                    const color = trend < -0.1 ? 'var(--accent-green)' : trend > 0.1 ? 'var(--accent-red)' : 'var(--text-secondary)';
                    return `<span style="color: ${color};">${sign}${trend.toFixed(3)}</span>`;
                };
                
                // Dla brainfog poka偶 jako Klarowno (odwr贸cone)
                const getDisplayValue = (period, metric) => {
                    if (metric === 'brainfog') {
                        const val = period.averages[metric];
                        return val !== null ? (11 - val).toFixed(2) : '-';
                    }
                    return formatValue(period.averages[metric]);
                };
                
                const getDisplayTrend = (period, metric) => {
                    if (metric === 'brainfog') {
                        // Dla Klarownoci odwracamy trend (spadek brainfog = wzrost klarownoci)
                        const trend = period.trends[metric];
                        return formatTrend(trend !== null ? -trend : null);
                    }
                    return formatTrend(period.trends[metric]);
                };
                
                const rows = periods.map(period => {
                    const cells = [
                        `<td><strong>Okres ${period.periodNumber}</strong><br><small style="color: var(--text-secondary);">${period.startDate} - ${period.endDate}</small></td>`,
                        `<td>${getDisplayValue(period, 'lek')}<br><small>${getDisplayTrend(period, 'lek')}</small></td>`,
                        `<td>${getDisplayValue(period, 'napiecie')}<br><small>${getDisplayTrend(period, 'napiecie')}</small></td>`,
                        `<td>${getDisplayValue(period, 'fokus')}<br><small>${getDisplayTrend(period, 'fokus')}</small></td>`,
                        `<td>${getDisplayValue(period, 'energia')}<br><small>${getDisplayTrend(period, 'energia')}</small></td>`,
                        `<td>${getDisplayValue(period, 'brainfog')}<br><small>${getDisplayTrend(period, 'brainfog')}</small></td>`,
                        `<td>${formatValue(period.averages.jakoscSnu)}<br><small>${formatTrend(period.trends.jakoscSnu)}</small></td>`
                    ].join('');
                    return `<tr>${cells}</tr>`;
                }).join('');
                
                return `
                    <div class="report-section">
                        <h3>Analiza Okres贸w 3-Dniowych</h3>
                        <p style="color: var(--text-secondary); margin-bottom: 15px;">
                            rednie wartoci objaw贸w i trendy (slope) dla ka偶dego 3-dniowego okresu obserwacji.
                            <br><small>Trend: wartoci ujemne (zielone) = poprawa, wartoci dodatnie (czerwone) = pogorszenie</small>
                        </p>
                        <div style="overflow-x: auto;">
                            <table style="width: 100%; border-collapse: collapse; font-size: 0.9rem;">
                                <thead>
                                    <tr style="background: var(--bg-hover); border-bottom: 2px solid var(--border);">
                                        <th style="padding: 12px; text-align: left; font-weight: 600;">Okres</th>
                                        <th style="padding: 12px; text-align: center; font-weight: 600;">Lk<br><small style="font-weight: 400;">(rednia / trend)</small></th>
                                        <th style="padding: 12px; text-align: center; font-weight: 600;">Napicie<br><small style="font-weight: 400;">(rednia / trend)</small></th>
                                        <th style="padding: 12px; text-align: center; font-weight: 600;">Fokus<br><small style="font-weight: 400;">(rednia / trend)</small></th>
                                        <th style="padding: 12px; text-align: center; font-weight: 600;">Energia<br><small style="font-weight: 400;">(rednia / trend)</small></th>
                                        <th style="padding: 12px; text-align: center; font-weight: 600;">Klarowno<br><small style="font-weight: 400;">(rednia / trend)</small></th>
                                        <th style="padding: 12px; text-align: center; font-weight: 600;">Jako Snu<br><small style="font-weight: 400;">(rednia / trend)</small></th>
                                    </tr>
                                </thead>
                                <tbody>
                                    ${rows}
                                </tbody>
                            </table>
                        </div>
                    </div>
                `;
            },
            
            // Sekcja: Skuteczno GAD
            renderGADEffectiveness: function(stats) {
                const gadTrend = stats.gadTrend || {};
                const comparison = stats.comparison || {};
                const lekTrend = gadTrend.lek || {};
                const napiecieTrend = gadTrend.napiecie || {};
                
                const response = this.interpretResponse(stats);
                
                return `
                    <div class="report-section">
                        <h3>Skuteczno Anxiolityczna (Cel G贸wny)</h3>
                        <p><strong>Odpowied藕 na wczenie Pregabaliny:</strong> ${response}</p>
                        
                        <h4> Trend Lku:</h4>
                        <ul>
                            <li>Nachylenie (slope): <strong>${lekTrend.slope ? lekTrend.slope.toFixed(4) : '-'}</strong> pkt/dzie</li>
                            <li>Korelacja z czasem: <strong>r = ${lekTrend.r ? lekTrend.r.toFixed(3) : '-'}</strong></li>
                            <li>Istotno statystyczna: <strong>p = ${this.formatPValue(lekTrend.pValue)}</strong></li>
                            <li>redni LK dni 1-5: <strong>${comparison.firstHalf && comparison.firstHalf.lek ? comparison.firstHalf.lek.toFixed(2) : '-'}</strong>  dni 6-10: <strong>${comparison.secondHalf && comparison.secondHalf.lek ? comparison.secondHalf.lek.toFixed(2) : '-'}</strong></li>
                            <li>ZMIANA: <strong style="color: var(--accent-green);">${comparison.change && comparison.change.lek ? comparison.change.lek.toFixed(1) : '-'}%</strong></li>
                        </ul>
                        
                        <h4> Trend Napicia:</h4>
                        <ul>
                            <li>Nachylenie (slope): <strong>${napiecieTrend.slope ? napiecieTrend.slope.toFixed(4) : '-'}</strong> pkt/dzie</li>
                            <li>Korelacja z czasem: <strong>r = ${napiecieTrend.r ? napiecieTrend.r.toFixed(3) : '-'}</strong></li>
                            <li>Istotno statystyczna: <strong>p = ${this.formatPValue(napiecieTrend.pValue)}</strong></li>
                            <li>rednie NAPICIE dni 1-5: <strong>${comparison.firstHalf && comparison.firstHalf.napiecie ? comparison.firstHalf.napiecie.toFixed(2) : '-'}</strong>  dni 6-10: <strong>${comparison.secondHalf && comparison.secondHalf.napiecie ? comparison.secondHalf.napiecie.toFixed(2) : '-'}</strong></li>
                            <li>ZMIANA: <strong style="color: var(--accent-green);">${comparison.change && comparison.change.napiecie ? comparison.change.napiecie.toFixed(1) : '-'}%</strong></li>
                        </ul>
                    </div>
                `;
            },
            
            // Sekcja: Stabilno ADHD
            renderADHDStability: function(stats) {
                const adhd = stats.adhdStability || {};
                const fokus = adhd.fokus || {};
                const energia = adhd.energia || {};
                
                return `
                    <div class="report-section">
                        <h3>Stabilno Leczenia ADHD (Cel Kontrolny)</h3>
                        <h4> FOKUS (proxy skutecznoci Elvanse):</h4>
                        <ul>
                            <li>rednia dni 1-5: <strong>${fokus.firstHalf ? fokus.firstHalf.toFixed(2) : '-'}</strong>  dni 6-10: <strong>${fokus.secondHalf ? fokus.secondHalf.toFixed(2) : '-'}</strong></li>
                            <li>Trend: <strong>${fokus.trend === 'stable' ? 'stabilny/rosncy ' : 'SPADKOWY 锔'}</strong></li>
                        </ul>
                        
                        <h4> ENERGIA:</h4>
                        <ul>
                            <li>rednia dni 1-5: <strong>${energia.firstHalf ? energia.firstHalf.toFixed(2) : '-'}</strong>  dni 6-10: <strong>${energia.secondHalf ? energia.secondHalf.toFixed(2) : '-'}</strong></li>
                            <li>INTERPRETACJA: <strong>${energia.trend === 'stable' ? 'Brak negatywnego wpywu Pregabaliny na leczenie ADHD ' : 'POTENCJALNA SEDACJA - wymaga obserwacji 锔'}</strong></li>
                        </ul>
                    </div>
                `;
            },
            
            // Sekcja: Wzorce dobowe
            renderIntradayPatterns: function(stats) {
                const patterns = stats.intradayPatterns || {};
                const avgByTime = patterns.avgByTime || {};
                
                return `
                    <div class="report-section">
                        <h3>Wzorce Dobowe</h3>
                        <h4> Rozkad Lku w cigu doby:</h4>
                        <ul>
                            <li>Najgorsza pora dnia: <strong>${patterns.worstTimeOfDay || '-'}</strong></li>
                            <li>Najlepsza pora dnia: <strong>${patterns.bestTimeOfDay || '-'}</strong></li>
                        </ul>
                        <h4>rednie wartoci lku:</h4>
                        <ul>
                            ${Object.keys(avgByTime).map(time => 
                                `<li>${time}: <strong>${avgByTime[time].toFixed(2)}</strong></li>`
                            ).join('')}
                        </ul>
                    </div>
                `;
            },
            
            // Sekcja: Wnioski
            renderConclusions: function(stats) {
                const gadTrend = stats.gadTrend || {};
                const lekTrend = gadTrend.lek || {};
                const comparison = stats.comparison || {};
                
                return `
                    <div class="report-section">
                        <h3>Wnioski Kliniczne</h3>
                        <ul>
                            <li> Pregabalina w dawce 225mg/d wykazuje <strong>${lekTrend.significant ? 'ISTOTNY' : 'UMIARKOWANY'}</strong> efekt redukcji objaw贸w GAD w okresie obserwacji.</li>
                            <li> redni poziom lku ${comparison.firstHalf && comparison.secondHalf && comparison.firstHalf.lek && comparison.secondHalf.lek ? 
                                `spad z <strong>${comparison.firstHalf.lek.toFixed(1)}</strong> do <strong>${comparison.secondHalf.lek.toFixed(1)}</strong> pkt (skala 1-10), co stanowi redukcj o <strong>${Math.abs(comparison.change.lek).toFixed(0)}%</strong>.` 
                                : 'wykazuje pozytywny trend.'}</li>
                            <li> Nie zaobserwowano istotnego pogorszenia parametr贸w ADHD (Fokus, Energia), co sugeruje dobr tolerancj kombinacji Elvanse + Pregabalina.</li>
                        </ul>
                    </div>
                `;
            },
            
            // Interpretacja odpowiedzi na leczenie
            interpretResponse: function(stats) {
                const gadTrend = stats.gadTrend || {};
                const lekTrend = gadTrend.lek || {};
                const napiecieTrend = gadTrend.napiecie || {};
                
                if (lekTrend.slope < -0.05 && napiecieTrend.slope < -0.05) {
                    return ' POZYTYWNA';
                } else if (lekTrend.slope < 0 || napiecieTrend.slope < 0) {
                    return '锔 CZCIOWO POZYTYWNA';
                } else {
                    return ' NIEJEDNOZNACZNA/NEGATYWNA';
                }
            },
            
            // Formatowanie p-value
            formatPValue: function(p) {
                if (p === null || p === undefined || isNaN(p)) return 'N/A';
                if (p < 0.01) return `${p.toFixed(4)} (istotne)`;
                if (p < 0.05) return `${p.toFixed(4)} (istotne)`;
                return `${p.toFixed(4)} (nieistotne)`;
            }
        };
        
        /* ===== UI CONTROLLER MODULE ===== */
        const UIController = {
            selectedSegments: {
                'chart-gad': true,
                'chart-intraday': true,
                'chart-adhd': true,
                'chart-stacked-area': true,
                'chart-sleep': true,
                'chart-correlation': true,
                'chart-sleep-anxiety': true,
                'chart-rolling-avg': true,
                'chart-weekly': true,
                'chart-radar': true,
                'chart-positive-vs-negative': true,
                'chart-metrics-by-time': true,
                'report': true
            },
            
            init: function() {
                this.initTheme();
                this.bindEvents();
                this.loadData();
            },
            
            initTheme: function() {
                const saved = localStorage.getItem(CONFIG.THEME_KEY) || 'dark';
                document.documentElement.setAttribute('data-theme', saved);
                this.updateThemeIcon(saved);
            },
            
            updateThemeIcon: function(theme) {
                const icon = document.getElementById('theme-toggle');
                if (icon) {
                    icon.textContent = theme === 'dark' ? '' : '锔';
                }
            },
            
            toggleTheme: function() {
                const current = document.documentElement.getAttribute('data-theme');
                const next = current === 'dark' ? 'light' : 'dark';
                document.documentElement.setAttribute('data-theme', next);
                localStorage.setItem(CONFIG.THEME_KEY, next);
                this.updateThemeIcon(next);
                
                // Update charts theme if ChartRenderer is ready
                if (ChartRenderer.setTheme) {
                    ChartRenderer.setTheme(next);
                }
            },
            
            
            switchTab: function(tabId) {
                // Hide all tabs
                document.querySelectorAll('.tab-content').forEach(tab => {
                    tab.classList.remove('active');
                });
                
                // Show selected tab
                const targetTab = document.getElementById(tabId);
                if (targetTab) {
                    targetTab.classList.add('active');
                }
                
                // Update nav
                document.querySelectorAll('.nav-tab').forEach(btn => {
                    btn.classList.remove('active');
                    if (btn.dataset.tab === tabId) {
                        btn.classList.add('active');
                    }
                });
                
                // Lazy load charts when dashboard tab is shown
                if (tabId === 'tab-dashboard') {
                    const plotGad = document.getElementById('plot-gad');
                    if (plotGad && (!plotGad.data || plotGad.data.length === 0)) {
                        const data = DataStore.load();
                        if (data && data.length > 0) {
                            const stats = StatsEngine.computeAll ? StatsEngine.computeAll(data) : null;
                            if (stats && ChartRenderer.renderAllCharts) {
                                ChartRenderer.renderAllCharts(data, stats);
                            }
                        }
                    }
                }
            },
            
            bindEvents: function() {
                // Theme toggle
                const themeToggle = document.getElementById('theme-toggle');
                if (themeToggle) {
                    themeToggle.addEventListener('click', () => this.toggleTheme());
                }
                
                // Tab navigation
                document.querySelectorAll('.nav-tab').forEach(btn => {
                    btn.addEventListener('click', () => {
                        this.switchTab(btn.dataset.tab);
                    });
                });
                
                // Import buttons
                const btnImport = document.getElementById('btn-import');
                const btnAppend = document.getElementById('btn-append');
                if (btnImport) {
                    btnImport.addEventListener('click', () => this.handleImport('replace'));
                }
                if (btnAppend) {
                    btnAppend.addEventListener('click', () => this.handleImport('append'));
                }
                
                // CSV upload
                const csvUpload = document.getElementById('csv-upload');
                if (csvUpload) {
                    csvUpload.addEventListener('change', (e) => {
                        const file = e.target.files[0];
                        if (file) {
                            const reader = new FileReader();
                            reader.onload = (event) => {
                                document.getElementById('raw-input').value = event.target.result;
                            };
                            reader.readAsText(file);
                        }
                    });
                }
                
                // Clear data
                const btnClear = document.getElementById('btn-clear');
                if (btnClear) {
                    btnClear.addEventListener('click', () => {
                        if (confirm('Czy na pewno chcesz usun wszystkie dane? Ta operacja jest nieodwracalna.')) {
                            if (DataStore.clear) {
                                DataStore.clear();
                                this.showToast('success', 'Dane zostay usunite');
                                this.refreshDashboard();
                            }
                        }
                    });
                }
                
                // Export CSV
                const btnExportCSV = document.getElementById('btn-export-csv');
                if (btnExportCSV) {
                    btnExportCSV.addEventListener('click', () => {
                        if (DataStore.exportCSV) {
                            const csv = DataStore.exportCSV();
                            const blob = new Blob([csv], { type: 'text/csv' });
                            const url = URL.createObjectURL(blob);
                            const a = document.createElement('a');
                            a.href = url;
                            a.download = 'pregabalin-data.csv';
                            a.click();
                            URL.revokeObjectURL(url);
                        }
                    });
                }
                
                // Print/Export
                const btnPrint = document.getElementById('btn-print');
                const btnExportPNG = document.getElementById('btn-export-png');
                if (btnPrint) {
                    btnPrint.addEventListener('click', () => this.exportSelected());
                }
                if (btnExportPNG) {
                    btnExportPNG.addEventListener('click', () => this.exportAllChartsPNG());
                }
                
                // Segment checkboxes - synchronizacja midzy panel export a checkboxy przy wykresach
                const segmentMapping = {
                    'check-chart-gad': 'chart-gad',
                    'check-chart-intraday': 'chart-intraday',
                    'check-chart-adhd': 'chart-adhd',
                    'check-stacked-area': 'chart-stacked-area',
                    'check-chart-correlation': 'chart-correlation',
                    'check-positive-vs-negative': 'chart-positive-vs-negative',
                    'check-metrics-by-time': 'chart-metrics-by-time',
                    'check-report': 'report'
                };
                
                document.querySelectorAll('.export-checkboxes input[type="checkbox"]').forEach(checkbox => {
                    checkbox.addEventListener('change', (e) => {
                        const segmentId = segmentMapping[e.target.id] || e.target.id.replace('check-', '');
                        this.toggleSegment(segmentId);
                        
                        // Synchronizuj checkbox przy wykresie jeli istnieje
                        const chartCheckbox = document.getElementById(segmentId.replace('chart-', 'check-'));
                        if (chartCheckbox) {
                            chartCheckbox.checked = e.target.checked;
                        }
                    });
                });
                
                // Checkboxy przy wykresach
                document.querySelectorAll('.chart-controls input[type="checkbox"]').forEach(checkbox => {
                    checkbox.addEventListener('change', (e) => {
                        const chartId = e.target.closest('.chart-card')?.id;
                        if (chartId) {
                            this.toggleSegment(chartId);
                            
                            // Synchronizuj g贸wny checkbox
                            const mainCheckbox = document.getElementById(`check-${chartId}`);
                            if (mainCheckbox) {
                                mainCheckbox.checked = e.target.checked;
                            }
                        }
                    });
                });
                
                // Table sorting
                document.querySelectorAll('#data-table th[data-sort]').forEach(th => {
                    th.addEventListener('click', () => {
                        if (TableManager.sort) {
                            TableManager.sort(th.dataset.sort);
                        }
                    });
                });
                
                // Table filters
                const filterDateFrom = document.getElementById('filter-date-from');
                const filterDateTo = document.getElementById('filter-date-to');
                const filterTimeOfDay = document.getElementById('filter-time-of-day');
                
                if (filterDateFrom) {
                    filterDateFrom.addEventListener('change', () => {
                        if (TableManager.filter) {
                            TableManager.filter({ dateFrom: filterDateFrom.value || null });
                        }
                    });
                }
                
                if (filterDateTo) {
                    filterDateTo.addEventListener('change', () => {
                        if (TableManager.filter) {
                            TableManager.filter({ dateTo: filterDateTo.value || null });
                        }
                    });
                }
                
                if (filterTimeOfDay) {
                    filterTimeOfDay.addEventListener('change', () => {
                        if (TableManager.filter) {
                            TableManager.filter({ timeOfDay: filterTimeOfDay.value || null });
                        }
                    });
                }
            },
            
            handleImport: function(mode) {
                const rawInput = document.getElementById('raw-input');
                const feedback = document.getElementById('import-feedback');
                
                if (!rawInput || !rawInput.value.trim()) {
                    this.showToast('error', 'Wprowad藕 dane do zaimportowania');
                    if (feedback) {
                        feedback.style.display = 'block';
                        feedback.style.background = 'rgba(239, 68, 68, 0.1)';
                        feedback.style.border = '1px solid var(--accent-red)';
                        feedback.style.color = 'var(--accent-red)';
                        feedback.textContent = 'Bd: Brak danych do zaimportowania';
                    }
                    return;
                }
                
                // Parsuj dane
                const result = DataParser.parseRAW(rawInput.value);
                
                if (result.errors.length > 0 && result.data.length === 0) {
                    // Tylko bdy, brak poprawnych danych
                    this.showToast('error', `Nie udao si zaimportowa danych. ${result.errors.length} bd贸w.`);
                    if (feedback) {
                        feedback.style.display = 'block';
                        feedback.style.background = 'rgba(239, 68, 68, 0.1)';
                        feedback.style.border = '1px solid var(--accent-red)';
                        feedback.style.color = 'var(--accent-red)';
                        feedback.innerHTML = `<strong>Bdy walidacji (${result.errors.length}):</strong><br>` + 
                            result.errors.slice(0, 10).join('<br>') + 
                            (result.errors.length > 10 ? `<br>... i ${result.errors.length - 10} wicej` : '');
                    }
                    return;
                }
                
                // Zapisz dane
                if (mode === 'replace') {
                    DataStore.save(result.data);
                    this.showToast('success', `Zaimportowano ${result.data.length} wpis贸w${result.errors.length > 0 ? ` (pominito ${result.errors.length} bdnych linii)` : ''}`);
                } else {
                    const appendResult = DataStore.append(result.data);
                    this.showToast('success', `Dodano ${appendResult.added} nowych wpis贸w${appendResult.duplicates > 0 ? ` (${appendResult.duplicates} duplikat贸w pominito)` : ''}${result.errors.length > 0 ? `, pominito ${result.errors.length} bdnych linii` : ''}`);
                }
                
                // Poka偶 feedback z bdami jeli s
                if (feedback) {
                    if (result.errors.length > 0) {
                        feedback.style.display = 'block';
                        feedback.style.background = 'rgba(245, 158, 11, 0.1)';
                        feedback.style.border = '1px solid var(--accent-amber)';
                        feedback.style.color = 'var(--accent-amber)';
                        feedback.innerHTML = `<strong>Ostrze偶enia (${result.errors.length}):</strong><br>` + 
                            result.errors.slice(0, 5).join('<br>') + 
                            (result.errors.length > 5 ? `<br>... i ${result.errors.length - 5} wicej` : '');
                    } else {
                        feedback.style.display = 'none';
                    }
                }
                
                // Wyczy input
                rawInput.value = '';
                
                // Odwie偶 dashboard
                this.refreshDashboard();
            },
            
            showToast: function(type, message) {
                const container = document.getElementById('toast-container');
                if (!container) return;
                
                const toast = document.createElement('div');
                toast.className = `toast ${type}`;
                toast.textContent = message;
                container.appendChild(toast);
                
                setTimeout(() => {
                    toast.style.animation = 'slideIn 0.3s reverse';
                    setTimeout(() => toast.remove(), 300);
                }, 5000);
            },
            
            refreshDashboard: function() {
                const data = DataStore.load ? DataStore.load() : [];
                this.updateDataSummary(data);
                
                // Aktualizuj tabel
                if (TableManager.render) {
                    TableManager.render('data-table', data);
                }
                
                // Aktualizuj raport
                if (data.length > 0 && StatsEngine.computeAll && DoctorReport.generate) {
                    const stats = StatsEngine.computeAll(data);
                    const reportHTML = DoctorReport.generate(data, stats);
                    const reportContainer = document.getElementById('doctor-report');
                    if (reportContainer) {
                        reportContainer.innerHTML = reportHTML;
                    }
                } else {
                    const reportContainer = document.getElementById('doctor-report');
                    if (reportContainer) {
                        reportContainer.innerHTML = '<p style="color: var(--text-secondary); text-align: center; padding: 40px;">Brak danych. Zaimportuj dane w zakadce "Import Danych", aby wygenerowa raport.</p>';
                    }
                }
                
                // Wykresy bd renderowane lazy przy pierwszym pokazaniu tabu Dashboard
            },
            
            updateDataSummary: function(data) {
                const summary = document.getElementById('data-summary');
                if (!summary) return;
                
                if (!data || data.length === 0) {
                    summary.innerHTML = '<p style="color: var(--text-secondary);">Brak danych</p>';
                    return;
                }
                
                const dates = [...new Set(data.map(d => d.Data))].sort();
                const dateRange = dates.length > 0 
                    ? `${dates[0]} - ${dates[dates.length - 1]}`
                    : 'Brak';
                
                summary.innerHTML = `
                    <p><strong>Liczba pomiar贸w:</strong> ${data.length}</p>
                    <p><strong>Liczba dni:</strong> ${dates.length}</p>
                    <p><strong>Okres:</strong> ${dateRange}</p>
                    <p><strong>rednia pomiar贸w/dzie:</strong> ${(data.length / dates.length).toFixed(1)}</p>
                `;
            },
            
            loadData: function() {
                this.refreshDashboard();
            },
            
            toggleSegment: function(segmentId) {
                if (!this.selectedSegments.hasOwnProperty(segmentId)) return;
                
                this.selectedSegments[segmentId] = !this.selectedSegments[segmentId];
                const el = document.getElementById(segmentId);
                if (el) {
                    el.classList.toggle('segment-hidden', !this.selectedSegments[segmentId]);
                }
                
                // Synchronizuj checkboxy
                const mainCheckbox = document.getElementById(`check-${segmentId}`);
                if (mainCheckbox) {
                    mainCheckbox.checked = this.selectedSegments[segmentId];
                }
                
                const chartCheckbox = document.querySelector(`#${segmentId} .chart-controls input[type="checkbox"]`);
                if (chartCheckbox) {
                    chartCheckbox.checked = this.selectedSegments[segmentId];
                }
            },
            
            exportSelected: function() {
                // Hide unselected segments for print
                Object.entries(this.selectedSegments).forEach(([id, selected]) => {
                    const el = document.getElementById(id);
                    if (el) {
                        if (!selected) {
                            el.setAttribute('data-print-hidden', 'true');
                        } else {
                            el.removeAttribute('data-print-hidden');
                        }
                    }
                });
                
                // Trigger print after a short delay to ensure DOM is updated
                setTimeout(() => {
                    window.print();
                    
                    // Restore after print (browser may not trigger this, but it's safe)
                    setTimeout(() => {
                        document.querySelectorAll('[data-print-hidden]').forEach(el => {
                            el.removeAttribute('data-print-hidden');
                        });
                    }, 100);
                }, 100);
            },
            
            exportAllChartsPNG: async function() {
                const chartMapping = {
                    'chart-gad': 'plot-gad',
                    'chart-intraday': 'plot-intraday',
                    'chart-adhd': 'plot-adhd',
                    'chart-stacked-area': 'plot-stacked-area',
                    'chart-sleep': 'plot-sleep',
                    'chart-correlation': 'plot-correlation',
                    'chart-sleep-anxiety': 'plot-sleep-anxiety',
                    'chart-rolling-avg': 'plot-rolling-avg',
                    'chart-weekly': 'plot-weekly',
                    'chart-radar': 'plot-radar',
                    'chart-positive-vs-negative': 'plot-positive-vs-negative',
                    'chart-metrics-by-time': 'plot-metrics-by-time'
                };
                
                const selectedCharts = Object.entries(this.selectedSegments)
                    .filter(([id, selected]) => selected && id.startsWith('chart-') && chartMapping[id])
                    .map(([id]) => ({ containerId: chartMapping[id], filename: id.replace('chart-', '') }));
                
                if (selectedCharts.length === 0) {
                    this.showToast('warning', 'Wybierz przynajmniej jeden wykres do eksportu');
                    return;
                }
                
                for (let i = 0; i < selectedCharts.length; i++) {
                    const chart = selectedCharts[i];
                    if (ChartRenderer.exportChart) {
                        if (i > 0) {
                            await new Promise(resolve => setTimeout(resolve, 500)); // Delay between exports
                        }
                        ChartRenderer.exportChart(chart.containerId, chart.filename);
                    }
                }
                
                this.showToast('success', `Eksportowano ${selectedCharts.length} wykres贸w`);
            }
        };
        
        /* ===== INITIALIZATION ===== */
        document.addEventListener('DOMContentLoaded', () => {
            UIController.init();
        });
    </script>
</body>
</html>

